<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Paths scene</title>
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
</head>
<body>
<a-scene cursor="rayOrigin: mouse" raycaster="objects: .fork-menu-button" keyboard-shortcuts="" screenshot="" xr-mode-ui="">
  <!-- Assets -->
  <a-assets>
    <img id="groundTexture" src="assets/grass.jpg">
    <img id="pathTexture" src="assets/stone.png">

    <!-- Tree models -->
    <a-asset-item id="tree1" src="assets/giant_oak_tree_voxel.glb"></a-asset-item>
    <a-asset-item id="tree2" src="assets/kapok_tree_voxel.glb"></a-asset-item>
    <a-asset-item id="tree3" src="assets/sequoia_redwood_tree_voxel.glb"></a-asset-item>
    <a-asset-item id="tree4" src="assets/voxel_models.glb"></a-asset-item>
  </a-assets>

  <!-- Ground (purely decorative; player cannot step off paths) -->
  <a-plane rotation="-90 0 0" width="50" height="50" material="repeat: 20 20; shader: flat; src: #groundTexture"></a-plane>

  <!-- Path geometry (visual) -->
  <!-- Intro vertical -->
  <a-box id="path_intro" width="1.5" height="0.05" depth="8" position="0 0.025 12.75" material="repeat: 1 4; shader: flat; src: #pathTexture"></a-box>

  <!-- Fork horizontal -->
  <a-box id="path_fork_h" width="7" height="0.05" depth="1.5" position="0 0.03943 8.75" material="repeat: 7 1; shader: flat; src: #pathTexture"></a-box>

  <!-- Branches -->
  <a-box id="path_left" class="branch" width="1.5" height="0.05" depth="14" position="-2.76655 0.025 1.00951" material="repeat: 1 7; shader: flat; src: #pathTexture"></a-box>
  <a-box id="path_middle" class="branch" width="1.5" height="0.05" depth="14" position="0 0.025 1.03888" material="repeat: 1 7; shader: flat; src: #pathTexture"></a-box>
  <a-box id="path_right" class="branch" width="1.5" height="0.05" depth="14" position="2.737 0.025 1.01381" material="repeat: 1 7; shader: flat; src: #pathTexture"></a-box>

  <!-- Ending horizontal (the one before final straight) -->
  <a-box id="path_ending_h" width="7" height="0.05" depth="1.5" position="0 0.03169 -6.25" material="repeat: 7 1; shader: flat; src: #pathTexture"></a-box>

  <!-- Final straight to castle -->
  <a-box id="path_final" width="1.5" height="0.05" depth="8" position="0 0.025 -10.75" material="repeat: 1 4; shader: flat; src: #pathTexture"></a-box>

  <!-- Fork menu (HUD) -->
  <a-entity id="forkMenu" visible="false" position="0 1.5 6">
    <a-box class="fork-menu-button" data-choice="left" position="-2 0 0" width="1" height="0.5" depth="0.2" color="blue"></a-box>
    <a-box class="fork-menu-button" data-choice="middle" width="1" height="0.5" depth="0.2" color="yellow"></a-box>
    <a-box class="fork-menu-button" data-choice="right" position="2 0 0" width="1" height="0.5" depth="0.2" color="red"></a-box>
  </a-entity>

  <!-- Castle -->
  <a-box id="castle" position="0 0.5 -15" width="2" height="2" depth="2" color="gold"></a-box>

  <!-- Player rig -->
  <a-entity id="rig" position="0 0.5 16" player-movement>
    <a-entity camera look-controls></a-entity>
  </a-entity>

  <!-- Tree container -->
  <a-entity id="trees"></a-entity>

<script>
// --- PLAYER MOVEMENT ---
AFRAME.registerComponent('player-movement', {
  init: function() {
    this.rig = this.el;
    this.choiceMade = false;
    this.frozen = false;

    // Start on intro path
    this.currentBounds = { xMin: -0.75, xMax: 0.75, zMin: 8.75, zMax: 16.75 };

    this.keys = {
      w:false, a:false, s:false, d:false,
      ArrowUp:false, ArrowDown:false, ArrowLeft:false, ArrowRight:false
    };

    window.addEventListener('keydown', e => { if(this.keys[e.key]!==undefined) this.keys[e.key]=true; });
    window.addEventListener('keyup', e => { if(this.keys[e.key]!==undefined) this.keys[e.key]=false; });

    // Fork menu click logic
    document.querySelectorAll('.fork-menu-button').forEach(btn => {
      btn.addEventListener('click', () => {
        const choice = btn.getAttribute('data-choice');
        this.choiceMade = true;
        this.frozen = false;
        document.getElementById('forkMenu').setAttribute('visible', false);
        this.rig.querySelector('[camera]').setAttribute('look-controls', 'enabled', true);

        // Bounds for chosen path
        if(choice==='left') this.currentBounds = {xMin:-3.5, xMax:-2.0, zMin:-6.25, zMax:8.75};
        if(choice==='middle') this.currentBounds = {xMin:-0.75, xMax:0.75, zMin:-6.25, zMax:8.75};
        if(choice==='right') this.currentBounds = {xMin:2.0, xMax:3.5, zMin:-6.25, zMax:8.75};

        // Block entrances and exits of unchosen paths
        ['left','middle','right'].forEach(path=>{
          if(path!==choice){
            ['entrance','exit'].forEach(posType=>{
              let wall = document.createElement('a-box');
              let z = posType==='entrance'?8.75:-6.25;
              let x = path==='left'?-2.8:path==='right'?2.8:0;
              wall.setAttribute('position', `${x} 0.5 ${z}`);
              wall.setAttribute('width','1.5'); wall.setAttribute('height','2'); wall.setAttribute('depth','0.5');
              wall.setAttribute('opacity','0');
              document.querySelector('a-scene').appendChild(wall);
            });
          }
        });
      });
    });
  },

  tick: function() {
    let pos = this.rig.getAttribute('position');
    const moveSpeed = 0.06; // slightly faster
    const smoothFactor = 0.25; 

    // Freeze at fork
    if(!this.choiceMade && pos.z <= 8.75){
      if(!this.frozen){
        this.frozen = true;
        document.getElementById('forkMenu').setAttribute('visible', true);
        this.rig.querySelector('[camera]').setAttribute('look-controls', 'enabled', false);
      }
      return;
    }
    if(this.frozen) return;

    // Movement input
    let dx=0,dz=0;
    if(this.keys.w||this.keys.ArrowUp) dz -= moveSpeed;
    if(this.keys.s||this.keys.ArrowDown) dz += moveSpeed;
    if(this.keys.a||this.keys.ArrowLeft) dx -= moveSpeed;
    if(this.keys.d||this.keys.ArrowRight) dx += moveSpeed;

    pos.x += dx*smoothFactor;
    pos.z += dz*smoothFactor;

    // Bounds per segment
    let bounds;
    if(pos.z > -6.25) bounds = this.currentBounds; // current chosen branch
    else bounds = { xMin: -3.5, xMax: 3.5, zMin: -15, zMax: -6.25 }; // last horizontal + final vertical

    pos.x = Math.max(bounds.xMin, Math.min(bounds.xMax,pos.x));
    pos.z = Math.max(bounds.zMin, Math.min(bounds.zMax,pos.z));

    this.rig.setAttribute('position', pos);
  }
});

// --- TREE SPAWNING BETWEEN BRANCHES ONLY ---
const trees = document.getElementById('trees');
const treeTypes = ['tree1','tree2','tree3','tree4'];

function inBranchPaths(x,z){
  // Avoid spawning on the three main paths
  if((x>=-3.5 && x<=-2.0 && z>=-6.25 && z<=8.75) ||
     (x>=-0.75 && x<=0.75 && z>=-6.25 && z<=8.75) ||
     (x>=2.0 && x<=3.5 && z>=-6.25 && z<=8.75)) return true;
  // Avoid last horizontal path
  if(z>=-6.25 && z<=-5.25) return true;
  return false;
}

// More trees between branches
for(let i=0;i<120;i++){
  let x = (Math.random()-0.5)*8; // around 3 branches
  let z = Math.random()*14-6; // from fork to last horizontal
  if(inBranchPaths(x,z)) continue;

  let type = treeTypes[Math.floor(Math.random()*treeTypes.length)];
  let scale = 0.02 + Math.random()*0.02;
  if(type==='tree4') scale*=30;
  let rotY = Math.random()*360;

  let tree = document.createElement('a-entity');
  tree.setAttribute('gltf-model', `#${type}`);
  tree.setAttribute('position', `${x} 0 ${z}`);
  tree.setAttribute('scale', `${scale} ${scale} ${scale}`);
  tree.setAttribute('rotation', `0 ${rotY} 0`);
  trees.appendChild(tree);
}
</script>


</a-scene>
</body>
</html>

