<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Paths Scene</title>
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
</head>
<body>
<a-scene cursor="rayOrigin: mouse" raycaster="objects: .fork-menu-button" keyboard-shortcuts="" screenshot="" xr-mode-ui="">

  <!-- Assets -->
  <a-assets>
    <img id="groundTexture" src="assets/grass.jpg">
    <img id="pathTexture" src="assets/stone.png">
    <a-asset-item id="tree1" src="assets/giant_oak_tree_voxel.glb"></a-asset-item>
    <a-asset-item id="tree2" src="assets/kapok_tree_voxel.glb"></a-asset-item>
    <a-asset-item id="tree3" src="assets/sequoia_redwood_tree_voxel.glb"></a-asset-item>
    <a-asset-item id="tree4" src="assets/voxel_models.glb"></a-asset-item>
  </a-assets>

  <!-- Ground (purely decorative) -->
  <a-plane rotation="-90 0 0" width="50" height="50" material="repeat: 20 20; shader: flat; src: #groundTexture"></a-plane>

  <!-- Paths -->
  <a-box id="path_intro" width="1.5" height="0.05" depth="8" position="0 0.025 12.75" material="repeat: 1 4; shader: flat; src: #pathTexture"></a-box>
  <a-box id="path_fork_h" width="7" height="0.05" depth="1.5" position="0 0.03943 8.75" material="repeat: 7 1; shader: flat; src: #pathTexture"></a-box>
  <a-box class="left-branch" width="1.5" height="0.05" depth="14" position="-2.76655 0.025 1.00951" material="repeat: 1 7; shader: flat; src: #pathTexture"></a-box>
  <a-box class="middle-branch" width="1.5" height="0.05" depth="14" position="0 0.025 1.03888" material="repeat: 1 7; shader: flat; src: #pathTexture"></a-box>
  <a-box class="right-branch" width="1.5" height="0.05" depth="14" position="2.737 0.025 1.01381" material="repeat: 1 7; shader: flat; src: #pathTexture"></a-box>
  <a-box id="path_end_h" width="7" height="0.05" depth="1.5" position="0 0.03169 -6.25" material="repeat: 7 1; shader: flat; src: #pathTexture"></a-box>
  <a-box id="path_final" width="1.5" height="0.05" depth="8" position="0 0.025 -10.75" material="repeat: 1 4; shader: flat; src: #pathTexture"></a-box>

  <!-- Fork menu -->
  <a-entity id="forkMenu" visible="false" position="0 1.5 6">
    <a-box class="fork-menu-button" data-choice="left" position="-2 0 0" width="1" height="0.5" depth="0.2" color="blue"></a-box>
    <a-box class="fork-menu-button" data-choice="middle" width="1" height="0.5" depth="0.2" color="yellow"></a-box>
    <a-box class="fork-menu-button" data-choice="right" position="2 0 0" width="1" height="0.5" depth="0.2" color="red"></a-box>
  </a-entity>

  <!-- Castle -->
  <a-box id="castle" position="0 0.5 -15" width="2" height="2" depth="2" color="gold"></a-box>

  <!-- Player rig -->
  <a-entity id="rig" position="0 0.5 16" player-movement>
    <a-entity camera look-controls></a-entity>
  </a-entity>

  <!-- Trees -->
  <a-entity id="trees"></a-entity>

<script>
AFRAME.registerComponent('player-movement', {
  init: function() {
    this.rig = this.el;
    this.choiceMade = false;
    this.frozen = false;
    this.keys = {w:false,a:false,s:false,d:false,ArrowUp:false,ArrowDown:false,ArrowLeft:false,ArrowRight:false};
    this.velocity = new THREE.Vector3();

    this.currentBounds = {xMin:-0.75,xMax:0.75,zMin:-15,zMax:16.75};
    this.forkZ = 8.75;
    this.freezePoint = {x:0, y:0.5, z:this.forkZ + 1.5};

    window.addEventListener('keydown', e => { if(this.keys[e.key]!==undefined) this.keys[e.key]=true; });
    window.addEventListener('keyup', e => { if(this.keys[e.key]!==undefined) this.keys[e.key]=false; });

    // Fork menu click logic
    document.querySelectorAll('.fork-menu-button').forEach(btn=>{
      btn.addEventListener('click', ()=>{ this.choosePath(btn.getAttribute('data-choice')); });
    });
  },

  choosePath: function(choice){
    this.choiceMade = true;
    this.frozen = false;
    document.getElementById('forkMenu').setAttribute('visible', false);

    // Tight bounds for chosen path
    if(choice==='left'){ this.currentBounds={xMin:-3,xMax:-2,zMin:-10,zMax:8.75}; }
    if(choice==='middle'){ this.currentBounds={xMin:-0.75,xMax:0.75,zMin:-10,zMax:8.75}; }
    if(choice==='right'){ this.currentBounds={xMin:2,xMax:3,zMin:-10,zMax:8.75}; }

    // Block unchosen paths
    ['left','middle','right'].forEach(p=>{
      if(p!==choice){
        let wall = document.createElement('a-box');
        wall.setAttribute('position', p==='left'?'-2.8 0.5 1':p==='middle'?'0 0.5 1':'2.8 0.5 1');
        wall.setAttribute('width','1.5'); wall.setAttribute('height','2'); wall.setAttribute('depth','10');
        wall.setAttribute('opacity','0'); document.querySelector('a-scene').appendChild(wall);
      }
    });
  },

  tick: function(time, deltaTime){
    const speed = 0.015;
    let dt = deltaTime / 16.666; // normalize for 60fps
    let move = new THREE.Vector3(
      (this.keys.d||this.keys.ArrowRight?1:0)-(this.keys.a||this.keys.ArrowLeft?1:0),
      0,
      (this.keys.s||this.keys.ArrowDown?1:0)-(this.keys.w||this.keys.ArrowUp?1:0)
    );

    // Normalize for diagonal movement
    if(move.length()>0) move.normalize().multiplyScalar(speed*dt*60);

    // Freeze at fork
    let pos = this.rig.getAttribute('position');
    if(!this.choiceMade && pos.z<=this.forkZ){
      this.frozen=true;
      pos.x = this.freezePoint.x; pos.y=this.freezePoint.y; pos.z=this.freezePoint.z;
      this.rig.setAttribute('position', pos);
      document.getElementById('forkMenu').setAttribute('visible', true);
      this.rig.querySelector('[camera]').setAttribute('look-controls','enabled',false);
      return;
    }
    else{ this.rig.querySelector('[camera]').setAttribute('look-controls','enabled',true); this.frozen=false; }

    if(this.frozen) return;

    // Move and collision
    let newPos = {x: pos.x + move.x, y: pos.y, z: pos.z + move.z};
    let bounds;
    if(pos.z > -6){ bounds=this.currentBounds; } // chosen path
    else{ bounds={xMin:-3.5,xMax:3.5,zMin:-15,zMax:8.75}; } // last horizontal + castle path
    newPos.x = Math.max(bounds.xMin, Math.min(bounds.xMax, newPos.x));
    newPos.z = Math.max(bounds.zMin, Math.min(bounds.zMax, newPos.z));

    this.rig.setAttribute('position', newPos);
  }
});

// --- Tree scattering ---
const trees = document.getElementById('trees');
const treeTypes = ['tree1','tree2','tree3','tree4'];

// Prevent trees from spawning on paths
function inPath(x,z){
  const pathBounds = [
    {x:0, z:[9,17]},
    {x:[-3.5,3.5], z:[8,10]},
    {x:-2.8, z:[-6,9]},
    {x:0, z:[-6,9]},
    {x:2.8, z:[-6,9]},
    {x:[-3.5,3.5], z:[-7,-6]},
    {x:0, z:[-15,-10]}
  ];
  return pathBounds.some(b=>{
    if(Array.isArray(b.x) && Array.isArray(b.z)) return x>=b.x[0]&&x<=b.x[1] && z>=b.z[0]&&z<=b.z[1];
    if(Array.isArray(b.x)) return x>=b.x[0]&&x<=b.x[1] && z>=b.z[0]&&z<=b.z[1];
    if(Array.isArray(b.z)) return Math.abs(x-b.x)<1 && z>=b.z[0]&&z<=b.z[1];
  });
}

// Scatter trees (more dense between 3 branches, smaller scale)
for(let i=0;i<200;i++){
  let x=(Math.random()-0.5)*50;
  let z=(Math.random()-0.5)*50;
  if(inPath(x,z)) continue;

  const type=treeTypes[Math.floor(Math.random()*treeTypes.length)];
  let scale = 0.005 + Math.random()*0.015;
  if(type==='tree4') scale*=20;
  let rotY=Math.random()*360;
  let tree=document.createElement('a-entity');
  tree.setAttribute('gltf-model', `#${type}`);
  tree.setAttribute('position', `${x} 0 ${z}`);
  tree.setAttribute('scale', `${scale} ${scale} ${scale}`);
  tree.setAttribute('rotation', `0 ${rotY} 0`);
  trees.appendChild(tree);
}
</script>
</a-scene>
</body>
</html>
