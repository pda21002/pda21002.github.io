<html>
<head>
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
</head>
<body>
<a-scene cursor="rayOrigin: mouse" raycaster="objects: .fork-menu-button" keyboard-shortcuts="">

  <!-- Assets -->
  <a-assets>
    <img id="groundTexture" src="assets/grass.jpg">
    <img id="pathTexture" src="assets/stone.png">

    <!-- Tree models -->
    <a-asset-item id="tree1" src="assets/giant_oak_tree_voxel.glb"></a-asset-item>
    <a-asset-item id="tree2" src="assets/kapok_tree_voxel.glb"></a-asset-item>
    <a-asset-item id="tree3" src="assets/sequoia_redwood_tree_voxel.glb"></a-asset-item>
    <a-asset-item id="tree4" src="assets/voxel_models.glb"></a-asset-item>
  </a-assets>

  <!-- Ground -->
  <a-plane rotation="-90 0 0" width="50" height="50"
           material="repeat: 20 20; shader: flat; src: #groundTexture"></a-plane>

  <!-- Paths -->
  <a-box width="1.5" height="0.05" depth="12.75" position="0 0.025 16" material="repeat: 1 6; shader: flat; src: #pathTexture"></a-box>
  <a-box width="9" height="0.05" depth="1.5" position="0 0.03943 9.5" material="repeat: 9 1; shader: flat; src: #pathTexture"></a-box>

  <!-- Branches stretched -->
  <a-box class="left-branch" width="1.5" height="0.05" depth="16.5" position="-2.76655 0.025 1.25" material="repeat: 1 8; shader: flat; src: #pathTexture"></a-box>
  <a-box class="middle-branch" width="1.5" height="0.05" depth="16.5" position="0 0.025 1.25" material="repeat: 1 8; shader: flat; src: #pathTexture"></a-box>
  <a-box class="right-branch" width="1.5" height="0.05" depth="16.5" position="2.737 0.025 1.25" material="repeat: 1 8; shader: flat; src: #pathTexture"></a-box>

  <!-- Horizontal lines -->
  <a-box width="9" height="0.05" depth="1.5" position="0 0.03169 -6.25" material="repeat: 9 1; shader: flat; src: #pathTexture"></a-box>
  <a-box width="2" height="0.05" depth="8" position="0 0.025 -10.75" material="repeat: 1 4; shader: flat; src: #pathTexture"></a-box>

  <!-- Fork menu -->
  <a-entity id="forkMenu" visible="false" position="0 1.5 6">
    <a-box class="fork-menu-button" data-choice="left" position="-2 0 0" width="1" height="0.5" depth="0.2" color="blue"></a-box>
    <a-box class="fork-menu-button" data-choice="middle" width="1" height="0.5" depth="0.2" color="yellow"></a-box>
    <a-box class="fork-menu-button" data-choice="right" position="2 0 0" width="1" height="0.5" depth="0.2" color="red"></a-box>
  </a-entity>

  <!-- Castle -->
  <a-box id="castle" position="0 0.5 -15" width="2" height="2" depth="2" color="gold"></a-box>

  <!-- Player -->
  <a-entity id="rig" position="0 0.5 16" player-movement="movementMode: camera">
    <a-entity camera look-controls></a-entity>
  </a-entity>

  <!-- Tree placeholders -->
  <a-entity id="trees"></a-entity>

<script>
AFRAME.registerComponent('player-movement', {
  schema: { movementMode: { type: 'string', default: 'camera' } },

  init: function () {
    this.currentBounds = { xMin:-0.75, xMax:0.75, zMin:-15, zMax:16.75 };
    this.choiceMade = false;
    this.chosenPath = null;

    this.keys = { ArrowUp:false, ArrowDown:false, ArrowLeft:false, ArrowRight:false };
    window.addEventListener('keydown', e => { if(this.keys.hasOwnProperty(e.key)) this.keys[e.key]=true; });
    window.addEventListener('keyup', e => { if(this.keys.hasOwnProperty(e.key)) this.keys[e.key]=false; });

    // Fork menu
    document.querySelectorAll('.fork-menu-button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        this.chosenPath = btn.getAttribute('data-choice');
        this.choiceMade = true;
        document.getElementById('forkMenu').setAttribute('visible', false);
      });
    });
  },

  tick: function () {
    const rig = this.el;
    let pos = rig.getAttribute('position');
    const speed = 0.05;

    // Stop at fork
    if(!this.choiceMade && pos.z <= 8.75){
      pos.z = 8.75;
      rig.setAttribute('position', pos);
      document.getElementById('forkMenu').setAttribute('visible', true);
      return;
    }

    // Camera-relative movement
    const camera = this.el.sceneEl.camera.el.object3D;
    const camDir = new THREE.Vector3();
    camera.getWorldDirection(camDir);
    camDir.y = 0;
    camDir.normalize();
    camDir.multiplyScalar(-1);

    const right = new THREE.Vector3().crossVectors(new THREE.Vector3(0,1,0), camDir).normalize();

    let dx=0, dz=0;
    if(this.keys.ArrowUp){ dx+=camDir.x*speed; dz+=camDir.z*speed; }
    if(this.keys.ArrowDown){ dx-=camDir.x*speed; dz-=camDir.z*speed; }
    if(this.keys.ArrowLeft){ dx-=right.x*speed; dz-=right.z*speed; }
    if(this.keys.ArrowRight){ dx+=right.x*speed; dz+=right.z*speed; }

    pos.x += dx;
    pos.z += dz;

    // --- Bounds ---
    let bounds;
    if(!this.choiceMade){
      bounds = { xMin:-0.75, xMax:0.75, zMin:-15, zMax:16.75 };
    } else if(pos.z > -6){
      if(this.chosenPath==='left') bounds={xMin:-2.8,xMax:-1.3,zMin:-10,zMax:10};
      if(this.chosenPath==='middle') bounds={xMin:-0.75,xMax:0.75,zMin:-10,zMax:10};
      if(this.chosenPath==='right') bounds={xMin:1.3,xMax:2.8,zMin:-10,zMax:10};
    } else {
      bounds = { xMin:-4, xMax:4, zMin:-15, zMax:16.75 }; // full access horizontal lines
    }

    pos.x = Math.max(bounds.xMin, Math.min(bounds.xMax, pos.x));
    pos.z = Math.max(bounds.zMin, Math.min(bounds.zMax, pos.z));
    rig.setAttribute('position', pos);
  }
});

// --- Tree scattering ---
const trees = document.getElementById('trees');
const treeTypes = ['tree1','tree2','tree3','tree4'];

function inPath(x,z){
  const pathBounds = [
    {x:0, z:[9,17]}, {x:[-4,4], z:[8,10]},
    {x:-2.8, z:[-6,10]}, {x:0, z:[-6,10]}, {x:2.8, z:[-6,10]},
    {x:[-4,4], z:[-7,-6]}, {x:0, z:[-15,-10]}
  ];
  return pathBounds.some(b => {
    if(Array.isArray(b.x) && Array.isArray(b.z)) return x>=b.x[0]&&x<=b.x[1] && z>=b.z[0]&&z<=b.z[1];
    if(Array.isArray(b.x)) return x>=b.x[0]&&x<=b.x[1] && z>=b.z[0]&&z<=b.z[1];
    if(Array.isArray(b.z)) return Math.abs(x-b.x)<1 && z>=b.z[0]&&z<=b.z[1];
  });
}

// General trees (keep size)
for(let i=0; i<150; i++){
  let x=(Math.random()-0.5)*50;
  let z=(Math.random()-0.5)*50;
  if(inPath(x,z)) continue;
  const type = treeTypes[Math.floor(Math.random()*treeTypes.length)];
  let scale = 0.01 + Math.random()*0.01;
  if(type==='tree4') scale *= 30;
  if(type==='tree3') scale *= 3;

  const rotY = Math.random()*360;
  let tree = document.createElement('a-entity');
  tree.setAttribute('gltf-model', `#${type}`);
  tree.setAttribute('position', `${x} 0 ${z}`);
  tree.setAttribute('scale', `${scale} ${scale} ${scale}`);
  tree.setAttribute('rotation', `0 ${rotY} 0`);
  trees.appendChild(tree);
}

// Blocking trees between branches
const branchXs = [-2.76655, 0, 2.737];
for(let i=0;i<30;i++){
  let branchIndex = Math.floor(Math.random()*branchXs.length);
  let x = branchXs[branchIndex] + (Math.random()-0.5)*1.2;
  let z = -6 + Math.random()*16.5;
  const type = treeTypes[Math.floor(Math.random()*treeTypes.length)];
  let scale = 0.015 + Math.random()*0.01;
  if(type==='tree4') scale*=30;
  if(type==='tree3') scale*=3;

  const rotY=Math.random()*360;
  let tree=document.createElement('a-entity');
  tree.setAttribute('gltf-model', `#${type}`);
  tree.setAttribute('position',`${x} 0 ${z}`);
  tree.setAttribute('scale',`${scale} ${scale} ${scale}`);
  tree.setAttribute('rotation',`0 ${rotY} 0`);
  trees.appendChild(tree);
}
</script>
</a-scene>
</body>
</html>
