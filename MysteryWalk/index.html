<html>
<head>
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
</head>
<body>
<a-scene cursor="rayOrigin: mouse" raycaster="objects: .fork-menu-button">

  <!-- Assets -->
  <a-assets>
    <img id="groundTexture" src="assets/grass.jpg">
    <img id="pathTexture" src="assets/stone.png">
    <a-asset-item id="tree1" src="assets/giant_oak_tree_voxel.glb"></a-asset-item>
    <a-asset-item id="tree2" src="assets/kapok_tree_voxel.glb"></a-asset-item>
    <a-asset-item id="tree3" src="assets/sequoia_redwood_tree_voxel.glb"></a-asset-item>
    <a-asset-item id="tree4" src="assets/voxel_models.glb"></a-asset-item>
  </a-assets>

  <!-- Ground & Paths -->
  <a-plane rotation="-90 0 0" width="50" height="50" material="repeat: 20 20; shader: flat; src: #groundTexture"></a-plane>
  <a-box width="1.5" height="0.05" depth="8" position="0 0.025 12.75" material="repeat: 1 4; shader: flat; src: #pathTexture"></a-box>
  <a-box width="7" height="0.05" depth="1.5" position="0 0.03943 8.75" material="repeat: 7 1; shader: flat; src: #pathTexture"></a-box>
  <a-box class="left-branch" width="1.5" height="0.05" depth="14" position="-2.76655 0.025 1.00951" material="repeat: 1 7; shader: flat; src: #pathTexture"></a-box>
  <a-box class="middle-branch" width="1.5" height="0.05" depth="14" position="0 0.025 1.03888" material="repeat: 1 7; shader: flat; src: #pathTexture"></a-box>
  <a-box class="right-branch" width="1.5" height="0.05" depth="14" position="2.737 0.025 1.01381" material="repeat: 1 7; shader: flat; src: #pathTexture"></a-box>
  <a-box width="7" height="0.05" depth="1.5" position="0 0.03169 -6.25" material="repeat: 7 1; shader: flat; src: #pathTexture"></a-box>
  <a-box width="1.5" height="0.05" depth="8" position="0 0.025 -10.75" material="repeat: 1 4; shader: flat; src: #pathTexture"></a-box>

  <!-- Fork menu -->
  <a-entity id="forkMenu" visible="false" position="0 1.5 6">
    <a-box class="fork-menu-button" data-choice="left" position="-2 0 0" width="1" height="0.5" depth="0.2" color="blue"></a-box>
    <a-box class="fork-menu-button" data-choice="middle" width="1" height="0.5" depth="0.2" color="yellow"></a-box>
    <a-box class="fork-menu-button" data-choice="right" position="2 0 0" width="1" height="0.5" depth="0.2" color="red"></a-box>
  </a-entity>

  <!-- Castle & Player -->
  <a-box id="castle" position="0 0.5 -15" width="2" height="2" depth="2" color="gold"></a-box>
  <a-entity id="rig" position="0 0.5 16" player-movement="movementMode: camera">
    <a-entity camera look-controls></a-entity>
  </a-entity>

  <!-- Tree placeholders -->
  <a-entity id="trees"></a-entity>

  <!-- Script -->
  <script>
    const trees = document.getElementById('trees');
    const treeTypes = ['tree1','tree2','tree3','tree4'];

    // --- Player movement ---
    AFRAME.registerComponent('player-movement', {
      init: function () {
        this.choiceMade = false;
        this.chosenPath = null;
        this.keys = { ArrowUp:false, ArrowDown:false, ArrowLeft:false, ArrowRight:false };

        window.addEventListener('keydown', e => { if(this.keys.hasOwnProperty(e.key)) this.keys[e.key]=true; });
        window.addEventListener('keyup', e => { if(this.keys.hasOwnProperty(e.key)) this.keys[e.key]=false; });

        document.querySelectorAll('.fork-menu-button').forEach(btn => {
          btn.addEventListener('click', () => {
            this.choiceMade = true;
            this.chosenPath = btn.getAttribute('data-choice');
            document.getElementById('forkMenu').setAttribute('visible', false);
          });
        });
      },

      tick: function () {
        const rig = this.el;
        let pos = rig.getAttribute('position');
        const speed = 0.05;

        // Stop at fork until choice
        if(!this.choiceMade && pos.z <= 8.75){
          pos.z = 8.75;
          rig.setAttribute('position', pos);
          document.getElementById('forkMenu').setAttribute('visible', true);
          return;
        }

        // Camera-relative movement
        const camera = this.el.sceneEl.camera.el.object3D;
        const camDir = new THREE.Vector3();
        camera.getWorldDirection(camDir);
        camDir.y=0; camDir.normalize();
        const right = new THREE.Vector3().crossVectors(new THREE.Vector3(0,1,0), camDir).normalize();

        let dx=0,dz=0;
        if(this.keys.ArrowUp){ dx -= camDir.x*speed; dz -= camDir.z*speed; }
        if(this.keys.ArrowDown){ dx += camDir.x*speed; dz += camDir.z*speed; }
        if(this.keys.ArrowLeft){ dx -= right.x*speed; dz -= right.z*speed; }
        if(this.keys.ArrowRight){ dx += right.x*speed; dz += right.z*speed; }

        pos.x += dx; pos.z += dz;

        // --- Compute bounds based on choice + funnel to castle ---
        function getBounds(choice, z){
          if(!choice) return {xMin:-0.75,xMax:0.75,zMin:-15,zMax:16.75}; // pre-fork

          if(choice==='middle') return {xMin:-0.75,xMax:0.75,zMin:-15,zMax:8.75};

          // left branch
          if(choice==='left') {
            if(z>=-10) return {xMin:-3.5,xMax:-1.5,zMin:-10,zMax:8.75}; // branch
            else return {xMin:-0.75,xMax:0.75,zMin:-15,zMax:-10};         // merge to center
          }

          // right branch
          if(choice==='right') {
            if(z>=-10) return {xMin:1.5,xMax:3.5,zMin:-10,zMax:8.75}; // branch
            else return {xMin:-0.75,xMax:0.75,zMin:-15,zMax:-10};       // merge to center
          }
        }

        const bounds = getBounds(this.chosenPath, pos.z);
        pos.x = Math.max(bounds.xMin, Math.min(bounds.xMax, pos.x));
        pos.z = Math.max(bounds.zMin, Math.min(bounds.zMax, pos.z));
        rig.setAttribute('position', pos);
      }
    });

    // --- Trees ---
    function inPath(x,z){
      const walkablePaths=[
        {x:0, z:[9,17]},
        {x:[-3.5,3.5], z:[8,10]},
        {x:-2.8, z:[-6,9]},{x:0, z:[-6,9]},{x:2.8, z:[-6,9]},
        {x:[-3.5,3.5], z:[-7,-6]},{x:0, z:[-15,-10]}
      ];
      return walkablePaths.some(b=>{
        if(Array.isArray(b.x)&&Array.isArray(b.z)) return x>=b.x[0]&&x<=b.x[1]&&z>=b.z[0]&&z<=b.z[1];
        if(Array.isArray(b.x)) return x>=b.x[0]&&x<=b.x[1]&&z>=b.z[0]&&z<=b.z[1];
        if(Array.isArray(b.z)) return Math.abs(x-b.x)<1&&z>=b.z[0]&&z<=b.z[1];
      });
    }

    for(let i=0;i<150;i++){
      let x=(Math.random()-0.5)*50;
      let z=(Math.random()-0.5)*50;
      if(inPath(x,z)) continue;
      const type=treeTypes[Math.floor(Math.random()*treeTypes.length)];
      let scale=0.01+Math.random()*0.02;
      if(type==='tree4') scale*=30;
      if(type==='tree3') scale*=3;
      const rotY=Math.random()*360;
      let tree=document.createElement('a-entity');
      tree.setAttribute('gltf-model', `#${type}`);
      tree.setAttribute('position', `${x} 0 ${z}`);
      tree.setAttribute('scale', `${scale} ${scale} ${scale}`);
      tree.setAttribute('rotation', `0 ${rotY} 0`);
      trees.appendChild(tree);
    }
  </script>

</a-scene>
</body>
</html>
