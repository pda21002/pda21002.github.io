<html>
<head>
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
</head>
<body>
<a-scene cursor="rayOrigin: mouse" raycaster="objects: .fork-menu-button">

  <!-- Assets -->
  <a-assets>
    <img id="groundTexture" src="assets/grass.jpg">
    <img id="pathTexture" src="assets/stone.png">
    <a-asset-item id="tree1" src="assets/giant_oak_tree_voxel.glb"></a-asset-item>
    <a-asset-item id="tree2" src="assets/kapok_tree_voxel.glb"></a-asset-item>
    <a-asset-item id="tree3" src="assets/sequoia_redwood_tree_voxel.glb"></a-asset-item>
    <a-asset-item id="tree4" src="assets/voxel_models.glb"></a-asset-item>
  </a-assets>

  <!-- Ground -->
  <a-plane rotation="-90 0 0" width="50" height="50" material="repeat: 20 20; shader: flat; src: #groundTexture"></a-plane>

  <!-- Paths -->
  <a-box width="1.5" height="0.05" depth="8" position="0 0.025 12.75" material="repeat: 1 4; shader: flat; src: #pathTexture"></a-box>
  <a-box width="7" height="0.05" depth="1.5" position="0 0.03943 8.75" material="repeat: 7 1; shader: flat; src: #pathTexture"></a-box>
  <a-box class="left-branch" width="1.5" height="0.05" depth="14" position="-2.76655 0.025 1.00951" material="repeat: 1 7; shader: flat; src: #pathTexture"></a-box>
  <a-box class="middle-branch" width="1.5" height="0.05" depth="14" position="0 0.025 1.03888" material="repeat: 1 7; shader: flat; src: #pathTexture"></a-box>
  <a-box class="right-branch" width="1.5" height="0.05" depth="14" position="2.737 0.025 1.01381" material="repeat: 1 7; shader: flat; src: #pathTexture"></a-box>
  <a-box width="7" height="0.05" depth="1.5" position="0 0.03169 -6.25" material="repeat: 7 1; shader: flat; src: #pathTexture"></a-box>
  <a-box width="1.5" height="0.05" depth="8" position="0 0.025 -10.75" material="repeat: 1 4; shader: flat; src: #pathTexture"></a-box>

  <!-- Fork menu (HUD) -->
  <a-entity id="forkMenu" visible="false" position="0 1.5 6">
    <a-box class="fork-menu-button" data-choice="left" position="-2 0 0" width="1" height="0.5" depth="0.2" color="blue"></a-box>
    <a-box class="fork-menu-button" data-choice="middle" width="1" height="0.5" depth="0.2" color="yellow"></a-box>
    <a-box class="fork-menu-button" data-choice="right" position="2 0 0" width="1" height="0.5" depth="0.2" color="red"></a-box>
  </a-entity>

  <!-- Castle -->
  <a-box id="castle" position="0 0.5 -15" width="2" height="2" depth="2" color="gold"></a-box>

  <!-- Player -->
  <a-entity id="rig" player-movement>
    <a-camera position="0 0.5 16"></a-camera>
  </a-entity>

  <!-- Tree container -->
  <a-entity id="trees"></a-entity>

  <script>
  // Paths bounds checker (for trees)
  function inPath(x,z){
    const paths = [
      {x:[-0.75,0.75], z:[8.5,17]},   // vertical intro
      {x:[-3, -2], z:[-10,8.75]},     // left branch
      {x:[-0.75,0.75], z:[-10,8.75]}, // middle branch
      {x:[2,3], z:[-10,8.75]},        // right branch
      {x:[-3.5,3.5], z:[-15,-10]}     // path to castle
    ];
    return paths.some(p => x>=p.x[0] && x<=p.x[1] && z>=p.z[0] && z<=p.z[1]);
  }

  const treeTypes = ['tree1','tree2','tree3','tree4'];

  // Scatter trees
  const trees = document.getElementById('trees');
  for(let i=0;i<400;i++){
    let x=(Math.random()-0.5)*50;
    let z=(Math.random()-0.5)*50;
    if(inPath(x,z)) continue; // skip paths

    const type = treeTypes[Math.floor(Math.random()*treeTypes.length)];
    let scale = 0.008 + Math.random()*0.015; // smaller between paths
    if(type==='tree4') scale *= 30;
    let rotY = Math.random()*360;

    let tree = document.createElement('a-entity');
    tree.setAttribute('gltf-model', `#${type}`);
    tree.setAttribute('position', `${x} 0 ${z}`);
    tree.setAttribute('scale', `${scale} ${scale} ${scale}`);
    tree.setAttribute('rotation', `0 ${rotY} 0`);
    trees.appendChild(tree);
  }

  // Player movement component
AFRAME.registerComponent('player-movement', {
  init: function() {
    this.keys = { w:false, a:false, s:false, d:false, ArrowUp:false, ArrowDown:false, ArrowLeft:false, ArrowRight:false };
    this.choiceMade = false;
    this.frozen = false;

    const rig = this.el;
    window.addEventListener('keydown', e => { if(this.keys[e.key]!==undefined) this.keys[e.key]=true; });
    window.addEventListener('keyup', e => { if(this.keys[e.key]!==undefined) this.keys[e.key]=false; });

    document.querySelectorAll('.fork-menu-button').forEach(btn => {
      btn.addEventListener('click', () => {
        this.choiceMade = true;
        this.frozen = false;
        document.getElementById('forkMenu').setAttribute('visible', false);
      });
    });
  },

tick: function() {
    const rig = this.el;
    let pos = rig.getAttribute('position');
    const speed = 0.015; // smaller base speed for smooth walking

    // Check if we should freeze at fork
    if (!this.choiceMade && pos.z <= 8.75) {
        this.frozen = true;
        pos.z = 8.75; // clamp to fork line
        rig.setAttribute('position', pos);
        rig.setAttribute('rotation', '0 0 0'); // face fork straight ahead
        document.getElementById('forkMenu').setAttribute('visible', true);
        return; // stop tick, player can't move
    }

    if (!this.frozen) {
        // Apply movement
        if (this.keys.w || this.keys.ArrowUp) pos.z -= speed;
        if (this.keys.s || this.keys.ArrowDown) pos.z += speed;
        if (this.keys.a || this.keys.ArrowLeft) pos.x -= speed;
        if (this.keys.d || this.keys.ArrowRight) pos.x += speed;

        rig.setAttribute('position', pos);
    }
};


  </script>

</a-scene>
</body>
</html>
