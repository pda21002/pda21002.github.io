<html> 
<head>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.4/dist/aframe-extras.min.js"></script>
  <a-assets> 
    <img id="groundTexture" src="assets/grass.jpg">
    <img id="pathTexture" src="assets/stone.png">
    <a-asset-item id="tree1" src="assets/giant_oak_tree_voxel.glb"></a-asset-item>
    <a-asset-item id="tree2" src="assets/kapok_tree_voxel.glb"></a-asset-item>
    <a-asset-item id="tree3" src="assets/sequoia_redwood_tree_voxel.glb"></a-asset-item>
    <a-asset-item id="tree4" src="assets/voxel_models.glb"></a-asset-item>
    <a-asset-item id="goblin" src="assets/goblin_mob.glb"></a-asset-item>
    <a-asset-item id="fairy1" src="assets/fairy_gm_villager1.glb"></a-asset-item>
    <a-asset-item id="fairy2" src="assets/fairy_gm_villager3.glb"></a-asset-item>
    <a-asset-item id="fairy3" src="assets/fairy_gm_villager4.glb"></a-asset-item>
    <a-asset-item id="fairy4" src="assets/fairy_gm_villager5.glb"></a-asset-item>
    <a-asset-item id="fairy5" src="assets/fairy_gm_villager6.glb"></a-asset-item>
    <a-asset-item id="house" src="assets/big_medieval_town_house_4.glb"></a-asset-item>
    <a-asset-item id="castle" src="assets/pixel_artvoxel_art_castle.glb"></a-asset-item>
    <a-asset-item id="witch" src="assets/little_witch.glb"></a-asset-item>
    <a-asset-item id="mushroom" src="assets/mushroom_bup_minecraft_mob.glb"></a-asset-item>
     <a-asset-item id="creepygirl" src="assets/creepy_girl.glb"></a-asset-item>
      <a-asset-item id="sisters" src="assets/sisters.glb"></a-asset-item>
      <a-asset-item id="dwarf" src="assets/swaying_dwarf.glb"></a-asset-item>
      <a-asset-item id="wizard" src="assets/the_green_wizard_gnome_n64_style.glb"></a-asset-item>
      <a-asset-item id="fox" src="assets/voxel_fox.glb"></a-asset-item>
          <a-asset-item id="ghost" src="assets/nightmare_creature_3.glb"></a-asset-item>
  </a-assets>
<script>
// Κίνηση παίκτη
AFRAME.registerComponent('player-movement', {
  init: function () {
    this.pause = false; 
    this.choiceMade = false; // Εντοπίζει αν ο παίκτης έχει επιλέξει μονοπάτι
    this.chosenPath = null; // Ποιο μονοπάτι επιλέχθηκε (left/middle/right)
    this.followingGoblin = false; // Αν ο παίκτης ακολουθεί το goblin
    this.keys = {ArrowUp:false, ArrowDown:false, ArrowLeft:false, ArrowRight:false}; // Ποιο arrow είναι πατημένο
    const scene = this.el.sceneEl; // Σκηνή
    
    // Χειρισμός πλήκτρων
    window.addEventListener('keydown', e => { if(this.keys.hasOwnProperty(e.key)) this.keys[e.key]=true; });
    window.addEventListener('keyup', e => { if(this.keys.hasOwnProperty(e.key)) this.keys[e.key]=false; });

    // Διαχείριση κουμπιών fork menu
    scene.querySelectorAll('.fork-menu-button').forEach(btn => {
      btn.addEventListener('click', () => { // Παρακολουθεί κλικ σε κουμπί
        this.chosenPath = btn.getAttribute('data-choice'); // Αποθηκεύει ποιο μονοπάτι επιλέχθηκε
        this.choiceMade = true; // Καταγράφεται η ολοκλήρωση της επιλογής
        document.getElementById('forkMenu').setAttribute('visible', false); // Κρύβει fork menu

        // Αφαίρεση fork-menu-button 
        scene.querySelectorAll('.fork-menu-button').forEach(b => b.classList.remove('fork-menu-button'));
        const cursorEl = scene.querySelector('[cursor]');
        if(cursorEl && cursorEl.components && cursorEl.components.raycaster)
          cursorEl.components.raycaster.data.objects = ''; // Εμποδίζει τον cursor από το να αλληλεπιδράσει με μη ενεργά κουμπιά
      });
      btn.setAttribute('material','depthTest:false;');
      btn.object3D.renderOrder = 999; // Εμφανίζει κουμπιά πάνω από υπόλοιπα αντικείμενα
    });
  },

tick: function () {
 if (this.pause) return;
  // Παρακολουθεί θέση και ταχύτητα
  const rig = this.el;
  let pos = rig.getAttribute('position');
  const speed = 0.025;

  // Κίνηση σε σχέση με κάμερα
  const camera = this.el.sceneEl.camera.el.object3D;
  const camDir = new THREE.Vector3(); // Παίρνει κατέυθυνση κάμερας
  camera.getWorldDirection(camDir);
  camDir.y = 0; camDir.normalize(); // Μόνο οριζόντια κίνηση
  const right = new THREE.Vector3().crossVectors(new THREE.Vector3(0,1,0), camDir).normalize();
  let dx=0, dz=0;
  // Εφαρμοφή κίνησης με πλήκτρα 
  if(this.keys.ArrowUp){ dx -= camDir.x*speed; dz -= camDir.z*speed; }
  if(this.keys.ArrowDown){ dx += camDir.x*speed; dz += camDir.z*speed; }
  if(this.keys.ArrowLeft){ dx -= right.x*speed; dz -= right.z*speed; }
  if(this.keys.ArrowRight){ dx += right.x*speed; dz += right.z*speed; }
  pos.x += dx; pos.z += dz;

// Περιορισμός κίνησης παίκτη στην διασταύρωση αν δεν έχει γίνει επιλογή μέχρι εκείνο το σημείο
const forkZ = 9.5;
if (!this.choiceMade && pos.z <= forkZ) {
  rig.setAttribute('position', {x: 0, y: pos.y, z: forkZ});
  
  // Δείχνει fork menu
  document.getElementById('forkMenu').setAttribute('visible', true);
  return;
}

  // Όρια κίνησης
  let bounds;
  if (!this.choiceMade) {
    // πριν την επιλογή
    bounds = {xMin:-0.75, xMax:0.75, zMin:9.5, zMax:29}; 
  } else {
    // μετά την επιλογή, ορισμός περιορισμών ανάλογα με το μονοπάτι που επιλέχθηκε
    if (pos.z <= 8.75 && pos.z > -6) {
      if (this.chosenPath === 'left') 
        bounds = {xMin:-3.3,xMax:-2.3,zMin:-6.25,zMax:8.75};
      else if (this.chosenPath === 'middle') 
        bounds = {xMin:-0.75,xMax:0.75,zMin:-6.25,zMax:8.75};
      else if (this.chosenPath === 'right' && !this.followingGoblin) 
        bounds = {xMin:2.2,xMax:3.2,zMin:-6.25,zMax:8.75};
      else 
        bounds = {xMin:-35,xMax:35,zMin:-35,zMax:35};
    } else {
      bounds = {xMin:-40,xMax:40,zMin:-40,zMax:40};
    }
  }
  // Όρια
  pos.x = Math.max(bounds.xMin, Math.min(bounds.xMax, pos.x));
  pos.z = Math.max(bounds.zMin, Math.min(bounds.zMax, pos.z));
  rig.setAttribute('position', pos);

  // Συνθήκη ήττας, αν ο παίκτης απομακρυνθεί από το origin
  const origin = new THREE.Vector3(0,0,16);
  const playerPos = new THREE.Vector3(pos.x,pos.y,pos.z);
  if(playerPos.distanceTo(origin) > 33){
    alert('You wandered too far and got lost! Game over.');
    window.location.reload();
  }
  }
}); 


// Component συμπεριφοράς goblin
AFRAME.registerComponent('goblin-behavior', {
  schema: {
    walkIndex: { type: 'int', default: 0 }, // Animation clip περπατήματος
    lookDistance: { type: 'number', default: 6 }, // Σε τι απόσταση από τον παίκτη κοιτάει το golbin προς το μέρος του
    startWalkDistance: { type: 'number', default: 1.6 }, // Σε τι απόσταση από τον παίκτη ξεκινάει να περπατάει
    speed: { type: 'number', default: 1.2 } // Ταχύτητα περπατήματος
  },
// Κατάσταση goblin όταν φορτώνεται
  init: function() {
    this.state = 'idle';
      // Για αναπαραγωγή animation
    this.mixer = null;
    this.walkAction = null;
    this.animations = []; // Λίστα animations μοντέλου
    this.modelRoot = null; // Root object μοντέλου
    this.hasLooked = false; // Αν έχει ήδη κοιτάξει τον παίκτη
    this.walkingStarted = false; // Αν έχει ξεκινήσει να περπατάει
    this.rig = document.getElementById('rig');

    // Τοποθέτηση goblin
    const pos = this.el.getAttribute('position');
    this.el.setAttribute('position', { x: pos.x, y: 0.05, z: pos.z });
// Περιμένει να φορτωθεί το μοντέλο
    this.el.addEventListener('model-loaded', (e) => {
      const gltfScene = e.detail.model;
      this.modelRoot = this.el.getObject3D('mesh') || gltfScene;
      this.animations = (gltfScene?.animations?.slice()) || []; // Αποθήκευση root object και animations

      if (this.modelRoot) {
        // Περιστροφή μοντέλου
        this.modelRoot.rotation.y = THREE.MathUtils.degToRad(-90);
      }
      this.el.object3D.rotation.set(0, 0, 0); // Ευθυγράμμιση με world axes
    });
  },

  tick: function(time, timeDelta) {
    if (!this.rig || !this.el.object3D) return; // Δεν κάνει τίποτα αν δεν υπάρχει παίκτης ή 3D object για το goblin
      // Υπολογισμός θέσης και απόστασης παίκτη από goblin στους x-z άξονες
    const gob3 = this.el.object3D;
    const rig3 = this.rig.object3D;
    const dx = rig3.position.x - gob3.position.x;
    const dz = rig3.position.z - gob3.position.z;
    const dist = Math.hypot(dx, dz);
    const dt = (timeDelta || 0) / 1000; 
// Ενημέρωση κατάστασης animation σε κάθε frame
    if (this.mixer) try { this.mixer.update(dt); } catch (err) {}

    // Goblin περιστρέφεται προς παίκτη όταν πλησιάζει
    if (this.state === 'idle' && dist <= this.data.lookDistance && !this.hasLooked) {
      const angleToPlayer = Math.atan2(
        rig3.position.x - gob3.position.x,
        rig3.position.z - gob3.position.z
      );
      gob3.rotation.y = angleToPlayer - THREE.MathUtils.degToRad(90);
      this.hasLooked = true;
    }

    // Ξεκινάει να περπατάει όταν ο παίκτης πλησιάζει περισσότερο
    if (this.state === 'idle' && dist <= this.data.startWalkDistance && !this.walkingStarted) {
      gob3.rotation.y = 0; // περιστροφή
// Φόρτωση και εκκίνηση animation
      if (this.modelRoot && this.animations.length > this.data.walkIndex) {
        try {
          this.mixer = new THREE.AnimationMixer(this.modelRoot);
          this.walkAction = this.mixer.clipAction(this.animations[this.data.walkIndex]);
          this.walkAction.setLoop(THREE.LoopRepeat);
          this.walkAction.play();
        } catch (err) {
          console.warn(err);
          this.mixer = null;
          this.walkAction = null;
        }
      }
// Ενημέρωση κατάστασης goblin
      this.walkingStarted = true;
      this.state = 'walking';
// Σύνδεση παίκτη με goblin
      const playerComp = this.rig.components['player-movement'];
      if (playerComp) playerComp.followingGoblin = true; // Εντοπίζει ότι ο παίκτης ακολουθεί το goblin
    }

    // Κίνηση
    if (this.state === 'walking') {
      const minSeparation = 0.6;
      if (dist > minSeparation) {
        gob3.position.x += this.data.speed * dt; 

        // "Κατεβαίνει" όταν φτάσει στην άκρη του μονοπατιού
        if (gob3.position.x > 3.525 && gob3.position.y > 0) {
          gob3.position.y = 0;
        }
// Ενημέρωση A-Frame entity
        this.el.setAttribute('position', {
          x: gob3.position.x,
          y: gob3.position.y,
          z: gob3.position.z
        });
      }
    }
  }
});

// Συμπεριφορά μάγισσας  
AFRAME.registerComponent('witch-behavior', {
  schema: {
    reactAnim: { type: 'string', default: 'bye' }, // animation clip μάγισσας
    reactDistance: { type: 'number', default: 2 } // Πόση απόσταση από παίκτη για να αντιδράσει
  },

  init: function() {
    this.player = document.querySelector('#rig'); // Εντοπισμός rig παίκτη
    this.mixer = null;
    this.actions = {};
this.textEl = this.el.parentNode.querySelector('#witchTextWrapper'); // Εντοπισμός element κειμένου μάγισσας
    this.hasPlayed = false; // Ελέγχει αν έχει παίξει το animation
// Περιμένει να φορτώσει το μοντέλο
    this.el.addEventListener('model-loaded', (e) => {
      const model = e.detail.model;
      if (!model) return;

      this.mixer = new THREE.AnimationMixer(model);

      const animations = model.animations || [];
      animations.forEach(clip => {
        const action = this.mixer.clipAction(clip);
          // Αν παίζει το προκαθορισμένο animation, να παίξει μία φορά και να μείνει στο τελευταίο frame
        if (clip.name === this.data.reactAnim) {
          action.setLoop(THREE.LoopOnce);
          action.clampWhenFinished = true;
        }
        this.actions[clip.name] = action;
      });
    });
  },

  tick: function(time, deltaTime) {
    if (!this.player || !this.mixer || !this.actions[this.data.reactAnim]) return; // Σταματά αν λείπει ο παίκτης, o mixer ή το animation
// Υπολογισμός θέσεων και απόστασης παίκτη και μάγισσας
    const playerPos = new THREE.Vector3();
    const witchPos = new THREE.Vector3();
    this.player.object3D.getWorldPosition(playerPos);
    this.el.object3D.getWorldPosition(witchPos);

    const distance = playerPos.distanceTo(witchPos);
// Αντίδραση μάγισσας αν ο παίκτης είναι κοντά της
    if (distance < this.data.reactDistance) {
      if (!this.hasPlayed) {
        // Παίζει το animation μία φορά
        this.actions[this.data.reactAnim].reset().play();
        this.hasPlayed = true;

        // Εμφάνιση κειμένου
        if (this.textEl) this.textEl.setAttribute('visible', true);

        // Κρύψιμο κειμένου μετά από 10 δευτερόλεπτα
        setTimeout(() => {
          if (this.textEl) this.textEl.setAttribute('visible', false);
        }, 10000);
      }
    } else {
      // Επανεκκίνηση, ώστε η συμπεριφορά να επαναληφθεί αν ο παίκτης ξαναπλησιάσει
      this.hasPlayed = false;
    }
// Ενημέρωση mixer, υπολογισμός χρόνου από προηγούμενο frame μέχρι τρέχον frame
    this.mixer.update(deltaTime / 1000);
  }
});
  // Συμπεριφορά νεράιδων
  AFRAME.registerComponent('fairy-behavior', {
  schema: {
    idleAnim: {type:'string', default:'Idle'}, // Animation που θα παίζει σε idle κατάσταση
    reactAnim: {type:'string', default:'React'}, // Animation που θα παίζει όταν ο παίκτης πλησιάζει
    reactDistance: {type:'number', default:2}, // Σε πόση απόσταση από τον παίκτη θα αλλάζει το animation
  },
  init:function(){
    this.rig=document.getElementById('rig');
    this.modelRoot=null; this.mixer=null;
    this.currentAction=null; this.idleAction=null; this.reactAction=null;

    this.el.addEventListener('model-loaded', (e)=>{
      const gltf=e.detail.model;
      this.modelRoot=this.el.getObject3D('mesh')||gltf;
      if(!this.modelRoot) return;
      const clips=gltf.animations||[];
      this.idleAction=null; this.reactAction=null;
      clips.forEach(c=>{
        if(c.name===this.data.idleAnim) this.idleAction=c;
        if(c.name===this.data.reactAnim) this.reactAction=c;
      });
      if(this.idleAction){
        this.mixer=new THREE.AnimationMixer(this.modelRoot);
        const act=this.mixer.clipAction(this.idleAction);
        act.play();
        this.currentAction='idle'; // Παίζει αμέσως idle animation
      }
    });
  },
      // Υπολογισμός θέσεων και απόστασης παίκτη και νεράιδων
  tick:function(time,timeDelta){
    if(!this.rig||!this.modelRoot||!this.mixer) return;
    const pos=this.el.object3D.position;
    const rigPos=this.rig.object3D.position;
    const dist=Math.hypot(pos.x-rigPos.x,pos.z-rigPos.z);
    const dt=(timeDelta||0)/1000;
// Αν ο παίκτης είναι κοντά στις νεράιδες και το τρέχον animation δεν είναι το react, σταματάει όλα τα animations
    if(dist<=this.data.reactDistance && this.reactAction && this.currentAction!=='react'){
      this.mixer.stopAllAction();
      const act=this.mixer.clipAction(this.reactAction);
      act.setLoop(THREE.LoopOnce); act.clampWhenFinished=true; act.play(); // Παίζει το react animation μία φορά
      this.currentAction='react';
        // Αν ο παίκτης απομακρυνθεί από τις νεράιδες και το τρέχον animation δεν είναι το idle, σταματάει όλα τα animations
    } else if(dist>this.data.reactDistance && this.idleAction && this.currentAction!=='idle'){
      this.mixer.stopAllAction();
      const act=this.mixer.clipAction(this.idleAction);
      act.setLoop(THREE.LoopRepeat); act.play(); // Παίζει το idle animation σε loop repeat
      this.currentAction='idle';
    }

    this.mixer.update(dt);
  }
});
  // Συμπεριφορά dwarf
  AFRAME.registerComponent('dwarf-behavior', {
    schema: {
      textId: {type: 'string', default: 'dwarfText'}, // κείμενο
      shadowId: {type: 'string', default: 'dwarfTextShadow'}, // σκιά κειμένου
      triggerDistance: {type: 'number', default: 1.4}, // Απόσταση από παίκτη στην οποία ενεργοποιείται το κείμενο
      displayTime: {type: 'number', default: 8000} // Χρόνος ορατότητας κειμένου
    },

    init: function () {
      this.camera = document.querySelector('[camera]'); // Εντοπισμός κάμερας
        // Αποθήκευση στοιχείων κειμένου και σκιάς κειμένου
      this.textEl = this.el.querySelector('#' + this.data.textId);
      this.shadowEl = this.el.querySelector('#' + this.data.shadowId);
      this.textTimeout = null; // Μεταβλητή για τον χειρισμό εξαφάνισης του κειμένου
    },

    tick: function () {
      if (!this.camera) return; // Αν δεν βρεθεί κάμερα, δεν κάνει τίποτα
// Υπολογισμός θέσεων και απόστασης παίκτη και νάνου
      const dwarfPos = new THREE.Vector3();
      const camPos = new THREE.Vector3();
      this.el.object3D.getWorldPosition(dwarfPos);
      this.camera.object3D.getWorldPosition(camPos);
      const distance = dwarfPos.distanceTo(camPos);
// Ενεργοποίηση / Απενεργοποίηση κειμένου
      if (distance < this.data.triggerDistance && !this.textEl.getAttribute('visible')) {
        this.textEl.setAttribute('visible', true);
        this.shadowEl.setAttribute('visible', true);
// Χρονόμετρο
        clearTimeout(this.textTimeout);
        this.textTimeout = setTimeout(() => {
          this.textEl.setAttribute('visible', false);
          this.shadowEl.setAttribute('visible', false);
        }, this.data.displayTime);
      }
    }
  });
//Συμπεριφορά μάγου  
AFRAME.registerComponent('wizard-interact', {
  schema: {
    idleAnim:        { type: 'string', default: 'Wizard_Gnome_Armature|idle' },
    approachAnim:    { type: 'string', default: 'Wizard_Gnome_Armature|Fall' },
    explainAnim:     { type: 'string', default: 'Wizard_Gnome_Armature|agree' },
    ignoreStartAnim: { type: 'string', default: 'Wizard_Gnome_Armature|disagree' },
    ignoreDeathAnim: { type: 'string', default: 'Wizard_Gnome_Armature|Hit' },
    getOutStartAnim: { type: 'string', default: 'Wizard_Gnome_Armature|Curse' },
    reactDistance:   { type: 'number', default: 2 },
    approachStep:    { type: 'number', default: 0.05 }, // κίνηση μάγου προς παίκτη
    choiceDelay:     { type: 'number', default: 700 } // καθυστέρηση εμφάνισης επιλογών στον παίκτη
  },
// Αποθήκευση στοιχείων παίκτη, κειμένου και επιλογών
  init: function() {
    this.player = document.querySelector('#rig');
    this.textEl = document.querySelector('#wizardText');
    this.shadowEl = document.querySelector('#wizardTextShadow');
    this.choices = document.querySelector('#wizardChoices');
    this.buttons = Array.from(this.choices.querySelectorAll('.wizard-choice'));

    this.mixer = null;
    this.actions = {};
    this.interacted = false;
    this.sequenceQueue = [];
    this.currentStep = null;
    this.travelled = 0;

    this.el.addEventListener('model-loaded', e => {
      const model = e.detail.model;
      if (!model) return;

      this.mixer = new THREE.AnimationMixer(model);
      (model.animations || []).forEach(clip => {
        const action = this.mixer.clipAction(clip);
        action.clampWhenFinished = true;
        this.actions[clip.name] = action;
      });

      this.playLoop(this.data.idleAnim);
    });
    // Σύνδεση κουμπιού με επιλογή παίκτη
    this.buttons.forEach(btn => {
      btn.addEventListener('click', () => 
        this.handleChoice(btn.getAttribute('data-choice'))
      );
    });
  },

  tick: function(time, delta) {
    if (this.mixer) this.mixer.update(delta / 1000);

    if (!this.interacted) {
      const playerPos = new THREE.Vector3();
      const wizardPos = new THREE.Vector3();
      this.player.object3D.getWorldPosition(playerPos);
      this.el.object3D.getWorldPosition(wizardPos);

      if (playerPos.distanceTo(wizardPos) < this.data.reactDistance) {
        this.interacted = true;
        this.startReaction();
      }
    }
   // Κάλυψη απόστασης moveDistance
    if (this.currentStep && this.currentStep.moveTowardPlayer) {
      const wizardPos = this.el.object3D.position;
      const playerZ = this.player.object3D.position.z;

      const dirZ = playerZ - wizardPos.z; // Υπολογισμός κατεύθυνσης
      const stepSize = this.data.approachStep;

      if (Math.abs(dirZ) > 0.001) {
       wizardPos.z -= Math.sign(dirZ) * Math.min(stepSize, Math.abs(dirZ));
        this.travelled += Math.min(stepSize, Math.abs(dirZ));

        if (this.travelled >= (this.currentStep.moveDistance || 0.65)) {
          this.currentStep.moveTowardPlayer = false;
        }
      }
    }
  },

  startReaction: function() {
    this.playLoop(this.data.getOutStartAnim);

    this.textEl.setAttribute('visible', true);
    this.shadowEl.setAttribute('visible', true);
    // Σταματάει κίνηση του παίκτη με μικρή καθυστέρηση και εμφανίζει επιλογές
    setTimeout(() => {
      if (this.player.components['player-movement'])
        this.player.components['player-movement'].pause = true;
      this.choices.setAttribute('visible', true);
    }, this.data.choiceDelay);
  },
// Κρύβει επιλογές και κείμενο όταν ο παίκτης έχει επιλέξει
  handleChoice: function(choice) {
    this.choices.setAttribute('visible', false);
    this.textEl.setAttribute('visible', false);
    this.shadowEl.setAttribute('visible', false);
// Ακολουθίες animation που παίζουν ανάλογα με την επιλογή
    switch(choice) {
      case 'ignore':
        this.playSequence([
          { anim: this.data.approachAnim, moveTowardPlayer: true, moveDistance: 0.65 },
          { anim: this.data.ignoreDeathAnim, repeat: 5 }
        ], () => alert('You died! Game over.'));
        break;

      case 'getOut':
        this.playSequence([
          { anim: this.data.getOutStartAnim, moveTowardPlayer: true, moveDistance: 0.65 },
          { anim: this.data.ignoreDeathAnim, repeat: 5 }
        ], () => alert('You died! Game over.'));
        break;

      case 'explain':
        this.playSequence([{ anim: this.data.explainAnim }], () => {
          if (this.player.components['player-movement'])
            this.player.components['player-movement'].pause = false;
          this.playLoop(this.data.idleAnim);
        });
        break;
    }
  },
// Σταματάει όλα τα animations και ενεργοποιεί ένα συγκεκριμένο animation σε loop repeat
  playLoop: function(animName) {
    if (!this.actions[animName]) return;
    Object.values(this.actions).forEach(a => a.stop()); // Σταματάει τα υπόλοιπα
    const action = this.actions[animName];
    action.reset();
    action.setLoop(THREE.LoopRepeat);
    action.play();
  },
 // Παίζει μια σειρά από animations που δίνονται στη λίστα queue
  playSequence: function(queue, callback) {
// Αν η λίστα είναι κενή, εκτελείται το callback και τελειώνει
    if (!queue || queue.length === 0) { if(callback) callback(); return; }

    const step = queue.shift();
    const action = this.actions[step.anim];
    if (!action) { this.playSequence(queue, callback); return; }
      
 // Ρυθμίσεις κίνησης προς παίκτη
    this.currentStep = step;
    if (step.moveTowardPlayer) {
      this.travelled = 0;   // Αν πρέπει να κινηθεί προς τον παίκτη, μηδενίζει την απόσταση που έχει διανύσει
    }
    // Σταμάτημα όλων των υπολοίπων animations και έναρξη τρέχοντος
    Object.values(this.actions).forEach(a => a.stop());
    action.reset();
    action.setLoop(THREE.LoopOnce);
    action.play();

    let repeats = step.repeat || 1;
    let count = 1;
    const mixer = this.mixer;
// Αν υπάρχει repeat, επαναλαμβάνει το animation τις φορές που ορίζεται
    const onFinished = () => {
      if (count < repeats) {
        count++;
        action.reset().play();
        return;
      }
      mixer.removeEventListener('finished', onFinished);
      this.currentStep = null;
      this.playSequence(queue, callback); // Προχωρά στο επόμενο animation της λίστας
    };
    mixer.addEventListener('finished', onFinished);
  }
});
    
// Συμπεριφορά creepy girl
AFRAME.registerComponent('creepygirl-behavior', {
  schema: {
    textId: {type: 'string', default: 'creepygirlText'},
    shadowId: {type: 'string', default: 'creepygirlTextShadow'},
    triggerDistance: {type: 'number', default: 2},
    displayTime: {type: 'number', default: 8000}  
  },

  init: function () {
    this.camera = document.querySelector('[camera]');
    this.textEl = document.getElementById(this.data.textId);
    this.shadowEl = document.getElementById(this.data.shadowId);
    this.textTimeout = null;
  },

  tick: function () {
    if (!this.camera) return;

    const girlPos = new THREE.Vector3();
    const camPos = new THREE.Vector3();
    this.el.object3D.getWorldPosition(girlPos);
    this.camera.object3D.getWorldPosition(camPos);
    const distance = girlPos.distanceTo(camPos);

    if (distance < this.data.triggerDistance && !this.textEl.getAttribute('visible')) {
      this.textEl.setAttribute('visible', true);
      this.shadowEl.setAttribute('visible', true);

      clearTimeout(this.textTimeout);
      this.textTimeout = setTimeout(() => {
        this.textEl.setAttribute('visible', false);
        this.shadowEl.setAttribute('visible', false);
      }, this.data.displayTime);
    }
  }
});

// Συμπεριφορά ghost
  AFRAME.registerComponent('ghost-behavior', {
    schema: {
      idleAnim: { type: 'string', default: 'thc3_arma|idle' },
      howlAnim: { type: 'string', default: 'thc3_arma|howl' },
      dieAnim:  { type: 'string', default: 'thc3_arma|die2' },
      attack3Anim: { type: 'string', default: 'thc3_arma|attack3' },
      attack1Anim: { type: 'string', default: 'thc3_arma|attack1' },
      attack2Anim:  { type: 'string', default: 'thc3_arma|attack2' },
      battleIdleAnim: { type: 'string', default: 'thc3_arma|battle_idle' },
      reactDistance: { type: 'number', default: 0.9 }
    },

    init: function () {
      this.player = document.querySelector('#rig');
      this.choices = document.querySelector('#ghostChoices');
      this.buttons = Array.from(this.choices.querySelectorAll('.ghost-choice'));

      this.mixer = null;
      this.actions = {};
      this.interacted = false; // Flag για να μην ξανατρέξει η αρχική αντίδραση
      this.sequenceQueue = [];

      this.el.addEventListener('model-loaded', e => {
        const model = e.detail.model;
        if (!model) return;

        this.mixer = new THREE.AnimationMixer(model);
        const clips = model.animations || [];

        clips.forEach(c => {
          const action = this.mixer.clipAction(c);
          action.clampWhenFinished = true;
          this.actions[c.name] = action;
        });

        if (this.actions[this.data.idleAnim]) {
          this.actions[this.data.idleAnim].setLoop(THREE.LoopRepeat);
          this.actions[this.data.idleAnim].play();
        }
      });

    // Σύνδεση κουμπιών επιλογών με την συνάρτηση handleChoice
      this.buttons.forEach(btn => {
        btn.addEventListener('click', () =>
          this.handleChoice(btn.getAttribute('data-choice'))
        );
      });
    },

    tick: function (time, dt) {
      if (this.mixer) this.mixer.update(dt/1000);
        
    // Έναρξη αντίδρασης όταν ο παίκτης πλησιάσει
      if (!this.interacted && this.mixer) {
        const playerPos = new THREE.Vector3();
        const ghostPos = new THREE.Vector3();
        this.player.object3D.getWorldPosition(playerPos);
        this.el.object3D.getWorldPosition(ghostPos);

        const dist = playerPos.distanceTo(ghostPos);
        if (dist < this.data.reactDistance) {
          this.interacted = true;
          this.startInteraction();
        }
      }
    },

    playLoop: function(animName) {
  if (!this.actions[animName]) return;

  Object.values(this.actions).forEach(a => a.stop());

  const action = this.actions[animName];
  action.reset();
  action.setLoop(THREE.LoopRepeat);
  action.play();
},

    startInteraction: function () {

      this.playLoop(this.data.battleIdleAnim);

      // Παγώνει την κίνηση του παίκτη
      if (this.player.components['player-movement'])
        this.player.components['player-movement'].pause = true;

      // Εμφάνιση επιλογών
      this.choices.setAttribute('visible', true);
    },

    handleChoice: function (choice) {
        // Κρύψιμο επιλογών
      this.choices.setAttribute('visible', false);

      switch(choice) {
        case 'kill':
          this.playSequence([
            { anim: this.data.howlAnim, loop: false },
            { anim: this.data.dieAnim, loop: false }
          ], () => {
            // Stay dead, unfreeze player
            if (this.player.components['player-movement'])
              this.player.components['player-movement'].pause = false;
          });
          break;

        case 'ignore':
          this.playSequence([
            { anim: this.data.attack3Anim, loop: false },
            { anim: this.data.attack2Anim, loop: false },
            { anim: this.data.attack1Anim, loop: false },
            { anim: this.data.attack3Anim, loop: false }
          ], () => {
            alert("The ghost cursed you. You died!");
          });
          break;
      }
    },

    playSequence: function(queue, callback) {
      if (!queue || queue.length === 0) {
        if (callback) callback();
        return;
      }
        
 const step = queue.shift();

  // Επιλογή action με όνομα animation
  const action = this.actions[step.anim];
  if (!action) {
    this.playSequence(queue, callback);
    return;
  }

      Object.values(this.actions).forEach(a => a.stop());
      action.reset();
      action.setLoop(step.loop === false ? THREE.LoopOnce : THREE.LoopRepeat);
      action.play();

      const mixer = this.mixer;
      const onFinished = () => {
        mixer.removeEventListener('finished', onFinished);
        this.playSequence(queue, callback);
      };
      mixer.addEventListener('finished', onFinished);
    }
  });

    // Συμπεριφορά sisters
AFRAME.registerComponent('sisters-behavior', {
  schema: {
    triggerDistance: {type: 'number', default: 2},
    displayTime: {type: 'number', default: 12000} 
  },

  init: function () {
    this.camera = document.querySelector('[camera]');
    this.hasInteracted = false; // flag για το αν ο παίκτης ήδη αλληλεπίδρασε

    this.hiTexts = [
      document.getElementById('sistersHiTextLeft'),
      document.getElementById('sistersHiTextShadowLeft'),
      document.getElementById('sistersHiTextRight'),
      document.getElementById('sistersHiTextShadowRight')
    ];

    this.ignoreTexts = [
      document.getElementById('sistersIgnoreText'),
      document.getElementById('sistersIgnoreTextShadow')
    ];

    this.hiBtn = document.getElementById('sistersHiBtn');
    this.ignoreBtn = document.getElementById('sistersIgnoreBtn');

    this.textTimeout = null;

    // Event listeners for buttons
    this.hiBtn.addEventListener('click', () => this.sayHi());
    this.ignoreBtn.addEventListener('click', () => this.ignore());
  },

  tick: function() {
    if (this.hasInteracted) return;
    if (!this.camera) return;

    const sisterPos = new THREE.Vector3();
    const camPos = new THREE.Vector3();
    this.el.object3D.getWorldPosition(sisterPos);
    this.camera.object3D.getWorldPosition(camPos);
    const distance = sisterPos.distanceTo(camPos);

    // Εμφάνιση κουμπιών μόνο όταν ο παίκτης είναι κοντά
    const visible = distance < this.data.triggerDistance;
    this.hiBtn.setAttribute('visible', visible);
    this.ignoreBtn.setAttribute('visible', visible);
  },

  sayHi: function() {
    this.showTexts(this.hiTexts);
    this.hasInteracted = true; // σηματοδοτεί ότι έγινε αλληλεπίδραση
    this.hideButtons(); // κρύβει τα κουμπιά
  },

  ignore: function() {
    this.showTexts(this.ignoreTexts);
    this.hasInteracted = true;
    this.el.setAttribute('animation-mixer', 'clip: Shh; loop: repeat');
    this.hideButtons();
  },

  hideButtons: function() {
    this.hiBtn.setAttribute('visible', false);
    this.ignoreBtn.setAttribute('visible', false);
  },

  showTexts: function(textArray) {
    textArray.forEach(t => t.setAttribute('visible', true));
    clearTimeout(this.textTimeout); // Ακυρώνει οποιοδήποτε προηγούμενο timeout υπήρχε
    this.textTimeout = setTimeout(() => { 
        // Δημιουργεί νέο timeout για να κρύψει τα κείμενα
      textArray.forEach(t => t.setAttribute('visible', false));
    }, this.data.displayTime);
  }
});

AFRAME.registerComponent('house-behavior', {
  init: function () {
    this.player = document.querySelector('#rig');
    this.choices = document.querySelector('#houseChoices');
    this.choicesShown = false;

    this.choices.querySelectorAll('.clickable').forEach(box => {
      box.addEventListener('click', (evt) => {
        const choice = box.getAttribute('data-choice');
        if (choice === 'leaveMessage') {
          alert("You left the message at a commoner's house! You lose!");
        }
          
        this.choices.setAttribute('visible', false);
      });
    });
  },

  tick: function () {
      // Αν οι επιλογές έχουν ήδη εμφανιστεί, δεν κάνουμε τίποτα
    if (this.choicesShown) return;
      
   // Παίρνουμε την τρέχουσα θέση του παίκτη
    const pos = new THREE.Vector3();
    this.player.object3D.getWorldPosition(pos);
      
   // Έλεγχος αν ο παίκτης είναι εντός της περιοχής κοντά στο σπίτι
    if (pos.z > 27 && pos.x > -0.75 && pos.x < 0.75) {
      this.choices.setAttribute('visible', true);
      this.choicesShown = true;
    }
  }
});

  AFRAME.registerComponent('castle-behavior', {
  init: function () {
    this.player = document.querySelector('#rig');
    this.choices = document.querySelector('#castleChoices');
    this.choicesShown = false;

    this.choices.querySelectorAll('.clickable').forEach(box => {
      box.addEventListener('click', () => {
        const choice = box.getAttribute('data-choice');
        if (choice === 'leaveMessage') {
          alert("You left the message at the castle. You WIN!");
        } else if (choice === 'ignore') {
          alert("You ignored the castle. You LOSE!");
        }
        this.choices.setAttribute('visible', false);
      });
    });
  },

  tick: function () {
    if (this.choicesShown) return;

    const pos = new THREE.Vector3();
    this.player.object3D.getWorldPosition(pos);

    if (pos.z < -14 && pos.x > -0.80 && pos.x < 0.75) {
      this.choices.setAttribute('visible', true);
      this.choicesShown = true;
    }
  }
});
    </script>
    <style>
        h1 { text-align: center; }
        h3 { text-align: center; }
        a-scene { width: 50%; height: 50%; border: dotted silver 1px; }
    </style>
</head>
<body>
    <h1>MYSTERY WALK</h1>
    <h3>Ελένη Ανδρεαδάκη</h3>
    <hr />
    <P><strong>Σενάριο:</strong> Είσαι αγγελιοφόρος στον Μεσαίωνα και πρέπει επειγόντως να παραδώσεις ένα μήνυμα στο παλάτι. Φαίνεται, όμως, ότι η τύχη σου σε έχει εγκαταλείψει… Μετά από ώρες δρόμου, φτάνεις σε ένα σταυροδρόμι βαθιά μέσα στο δάσος. Πάνω που νόμιζες ότι ήσουν στην τελική ευθεία, τώρα δεν ξέρεις προς τα πού να κινηθείς! Ίσως η τύχη σου να σε καθοδηγήσει. Θα καταφέρεις να ξεπεράσεις τα εμπόδια που μπορεί να εμφανιστούν στον δρόμο σου και να φτάσεις στο παλάτι;</P>
    <hr />
    <div align="center">
      <a-scene cursor="rayOrigin: mouse"
         raycaster="objects: .clickable, .fork-menu-button, .ghost-choice"
        ondblclick="this.requestFullscreen();" embedded>>

  <!-- Ουρανός -->
    <a-sky color="#87CEEB"></a-sky>

  <!-- Έδαφος -->
  <a-plane rotation="-90 0 0" width="80" height="80"
           material="repeat: 30 30; shader: flat; src: #groundTexture"></a-plane>

  <!-- Μονοπάτια -->
  <a-box width="1.5" height="0.05" depth="20" position="0 0.025 19.46702" 
         material="repeat: 1 7; shader: flat; src: #pathTexture"></a-box>
  <a-box width="7" height="0.05" depth="1.5" position="0 0.03943 8.75"
         material="repeat: 7 1; shader: flat; src: #pathTexture"></a-box>
  <a-box class="left-branch" width="1.5" height="0.05" depth="14" position="-2.76655 0.025 1.00951"
         material="repeat: 1 7; shader: flat; src: #pathTexture"></a-box>
  <a-box class="middle-branch" width="1.5" height="0.05" depth="14" position="0 0.025 1.03888"
         material="repeat: 1 7; shader: flat; src: #pathTexture"></a-box>
  <a-box class="right-branch" width="1.5" height="0.05" depth="14" position="2.737 0.025 1.01381"
         material="repeat: 1 7; shader: flat; src: #pathTexture"></a-box>
  <a-box width="7" height="0.05" depth="1.5" position="0 0.03169 -6.25"
         material="repeat: 7 1; shader: flat; src: #pathTexture"></a-box>
  <a-box width="1.5" height="0.05" depth="8" position="0 0.025 -10.75"
         material="repeat: 1 4; shader: flat; src: #pathTexture"></a-box>



  <!-- Επιλογές διακλαδώσεων -->
 <a-entity id="forkMenu" visible="false" position="0 1.5 6">
    <a-box class="fork-menu-button" data-choice="left" position="-2 0 0" width="1" height="0.5" depth="0.2" color="red">
    </a-box>
    <a-box class="fork-menu-button" data-choice="middle" width="1" height="0.5" depth="0.2" color="yellow">
   </a-box>
    <a-box class="fork-menu-button" data-choice="right" position="2 0 0" width="1" height="0.5" depth="0.2" color="blue">
    </a-box>
  </a-entity>

  <!-- Παλάτι -->
  <a-entity gltf-model="#castle" position="6.99881 -0.8 -76.225" width="2" castle-behavior></a-entity>

  <a-entity id="castleChoices" visible="false" position="0 1 -15">
  <a-box class="castle-choice clickable"
         data-choice="leaveMessage"
         color="green" width="1.5" height="0.6" depth="0.2"
         position="-1 0 0">
    <a-text value="Leave message here"
            align="center"
            color="white"
            width="1.5"
            wrap-count="12"
            baseline="center"
            position="0 0 0.11">
    </a-text>
  </a-box>

  <a-box class="castle-choice clickable"
         data-choice="ignore"
         color="red" width="1.5" height="0.6" depth="0.2"
         position="1 0 0">
    <a-text value="Ignore"
            align="center"
            color="white"
            width="1.5"
            wrap-count="8"
            baseline="center"
            position="0 0 0.11">
    </a-text>
  </a-box>
</a-entity>

  <!-- Παίκτης -->
  <a-entity id="rig" position="0 0.5 16" player-movement>
    <a-entity camera look-controls></a-entity>
  </a-entity>

  <!-- Σπίτι -->
<a-entity gltf-model="#house" position="-0.16089 0 30.2737" scale="0.15 0.18 0.15" rotation="0 180 0" house-behavior></a-entity> 
<a-entity id="houseChoices" visible="false" position="-0.02045 0.75 29.066" scale="0.33 0.3 1"> 
<a-box class="house-choice clickable" data-choice="leaveMessage" color="red" width="1" height="0.5" depth="0.2" position="-0.8 0 0">
 <a-text value="Leave message here" align="center" color="white" width="1" side="double" wrap-count="12" baseline="center" position="0 0 -0.11" rotation="0 180 0"></a-text>
</a-box> 
<a-box class="house-choice clickable" data-choice="ignore" color="green" width="1" height="0.5" depth="0.2" position="0.8 0 0">
 <a-text value="Ignore this place" align="center" color="white" width="1" side="double" wrap-count="12" baseline="center" position="0 0 -0.11" rotation="0 180 0"></a-text>
</a-box> 
</a-entity>


  <!-- Δέντρα -->
  <a-entity id="trees"></a-entity>

  <!-- Νεράιδες -->
  <a-entity id="fairies">
    <a-entity gltf-model="#fairy1" position="3.74164 0.77241 7.10959" scale="0.08 0.08 0.08" rotation="0 155 0" fairy-behavior="idleAnim:idle; reactAnim:interact1; reactDistance:2"></a-entity>
    <a-entity gltf-model="#fairy2" position="3.7658 0.95 7.2" scale="0.08 0.08 0.08" rotation="-10.94 140.27 0" fairy-behavior="idleAnim:idle; reactAnim:interact2; reactDistance:2"></a-entity>
    <a-entity gltf-model="#fairy3" position="3.6441 0.85 7.09739" scale="0.08 0.08 0.08" rotation="0 150 0" fairy-behavior="idleAnim:idle; reactAnim:cantar; reactDistance:2"></a-entity>
    <a-entity gltf-model="#fairy4" position="3.82107 0.81339 7.2185" scale="0.08 0.08 0.08" rotation="0 132 0" fairy-behavior="idleAnim:idle; reactAnim:interact1; reactDistance:2"></a-entity>
    <a-entity gltf-model="#fairy5" position="3.65 1 7.15" scale="0.08 0.08 0.08" rotation="-14.46 150 0" fairy-behavior="idleAnim:idle; reactAnim:interact1; reactDistance:2"></a-entity>
  </a-entity>

  
  <!-- Μάγισσα -->
<a-entity id="witchWrapper" position="2.35 0.04454 4.80785" rotation="0 -14.72 0">
  <a-entity gltf-model="#witch"
            scale="0.25 0.25 0.25"
            rotation="0 -135 0"
            witch-behavior="reactAnim: bye; reactDistance: 2">
  </a-entity>

  <a-entity id="witchTextWrapper" visible="false">
    <a-text value="Hello! If you're looking for the palace, you're on the right path. Just don't get distracted!"
            position="0.15816 0.44674 0.11927"
            align="center"
            color="#000"
            side="double"
            scale="0.15 0.15 0.15"
            rotation="0 40 0">
    </a-text>

    <a-text value="Hello! If you're looking for the palace, you're on the right path. Just don't get distracted!"
            position="0.15725 0.44674 0.12232"
            align="center"
            color="#fff"
            side="double"
            scale="0.15 0.15 0.15"
            rotation="0 40 0">
    </a-text>
  </a-entity>
</a-entity>

    <!-- Μάγος -->
  <a-entity id="wizardWrapper" position="-0.02192 0.04843 -1.66883">
  <a-entity gltf-model="#wizard" scale="0.4 0.4 0.4"
            wizard-interact="range: 1.5; textId: wizardText"></a-entity>
    
<a-text value="WHERE DO YOU THINK YOU'RE GOING?!" position="0.00345 0.45824 0.00929" color="#000" align="center" side="double" scale="0.25 0.25 0.25" visible="false" id="wizardTextShadow"></a-text>
<a-text value="WHERE DO YOU THINK YOU'RE GOING?!" position="0 0.46284 0.01" color="#fff" align="center" side="double" scale="0.25 0.25 0.25" visible="false" id="wizardText"></a-text>
</a-entity>

<a-entity id="wizardChoices" visible="false" position="0 0.35 -1.71145" scale="0.44 0.43 0.23">
  <a-box class="wizard-choice clickable" data-choice="ignore" color="red" width="1" height="0.5" depth="0.2" position="-1 1 0">
         <a-text value="Ignore him" align="center" color="white" width="1" height="0.5" side="double" wrap-count="8" baseline="center" position="0 0 0.11" scale="0.5 0.5 0.5"></a-text>
  </a-box>

  <a-box class="wizard-choice clickable" data-choice="explain" color="green" width="1" height="0.5" depth="0.2" position="0 1 0">
         <a-text value="Explain your purpose" align="center" color="white" width="1" height="0.5" side="double" wrap-count="8" baseline="center" position="0 0 0.11" scale="0.5 0.5 0.5"></a-text>
  </a-box>

  <a-box class="wizard-choice clickable" data-choice="getOut" color="blue" width="1" height="0.5" depth="0.2" position="1 1 0">
         <a-text value="Tell him to get out of your way!" align="center" color="white" width="1" height="0.5" side="double" wrap-count="8" baseline="center" position="0 0 0.11" scale="0.5 0.5 0.5"></a-text>
  </a-box>
</a-entity>

  <!-- Μανιτάρι -->
  <a-entity gltf-model="#mushroom" position="3.335 0.05 0" rotation="0 150 0" scale="0.15 0.15 0.15" animation-mixer="clip: idle; loop: repeat;"></a-entity>

  <!-- Goblin -->
  <a-entity gltf-model="#goblin" position="2.5 0 -4" scale="0.3 0.3 0.3" goblin-behavior="walkIndex:0; lookDistance:4; startWalkDistance:1.6; speed:1.2"></a-entity>
          
  <!-- Αλεπού -->
  <a-entity gltf-model="#fox" position="0.33427 0.05 7.18987" scale="0.045 0.045 0.045" rotation="0 70 0" animation-mixer="loop: repeat"></a-entity>

<!-- Ghost -->
  <a-entity gltf-model="#ghost" position="-2.8142 0.08774 -3.2995" scale="0.2 0.2 0.2" ghost-behavior></a-entity>

 <a-entity id="ghostChoices" visible="false" position="-2.8142 1.04864 -3.21153" scale="0.24 0.19 0.3">
    <a-box class="ghost-choice" data-choice="kill" color="red" width="1" height="0.5" depth="0.2" position="-1 0 0">
           <a-text value="Kill him" align="center" color="white" width="1" side="double" wrap-count="8" baseline="center" position="0 0 0.11"></a-text>
    </a-box>
    <a-box class="ghost-choice" data-choice="ignore" color="blue" width="1" height="0.5" depth="0.2" position="1 0 0">
           <a-text value="Ignore him" align="center" color="white" width="1" side="double" wrap-count="8" baseline="center" position="0 0 0.11"></a-text>
    </a-box>
  </a-entity>

  <!-- Dwarf -->
<a-entity gltf-model="#dwarf" position="-0.29412 0.05046 4.64215" scale="0.008 0.008 0.008" rotation="0 20 0" animation-mixer="loop: repeat" dwarf-behavior>

  <a-text id="dwarfTextShadow" value="Hey there. Beware of the little man ahead..." position="0.14818 57.53025 0.16439" color="#000" align="center" side="double" scale="20 20 20" visible="false">
  </a-text>

  <a-text id="dwarfText" value="Hey there. Beware of the little man ahead..." position="0.5158 57.34025 0.24706" color="#fff" align="center" side="double" scale="20 20 20" visible="false">
  </a-text>

</a-entity>

  <!-- Creepy girl -->
  <a-entity gltf-model="#creepygirl" position="-3.20252 0.04765 5.73719" scale="0.0007 0.0007 0.0007" rotation="0 25 0" animation-mixer="loop: repeat" creepygirl-behavior></a-entity>

<a-text id="creepygirlTextShadow" value="Oh, heyyy!! You are in for SO much fun!!" position="-3.20624 0.84448 5.7611" color="#000" align="center" side="double" scale="0.2 0.2 0.2" visible="false" rotation="0 25 0"> </a-text>

<a-text id="creepygirlText" value="Oh, heyyy!! You are in for SO much fun!!" position="-3.20146 0.84521 5.76091" color="#fff" align="center" side="double" scale="0.2 0.2 0.2" visible="false" rotation="0 25 0"> </a-text>
</a-entity>

    <!-- Sisters -->
<a-entity id="sisters" 
          gltf-model="#sisters" 
          position="-2.60894 0.58665 1.29681" 
          scale="0.08 0.08 0.08" 
          rotation="0 -110 0"
          animation-mixer="clip: Idle; loop: repeat"
          sisters-behavior>
</a-entity>

  <a-box id="sistersHiBtn" 
       class="clickable" 
       position="-2.9 1 1.2" 
       width="0.5" height="0.2" depth="0.15" 
       color="green">
         <a-text value="Say hi!" align="center" color="white" width="1" height="1" side="double" wrap-count="4" baseline="center" position="0 0 0.11" scale="0.2 0.2 0.2"></a-text>
</a-box>

<a-box id="sistersIgnoreBtn" 
       class="clickable" 
       position="-2.3 1 1.2" 
       width="0.5" height="0.2" depth="0.15" 
       color="red">
       <a-text value="Ignore them" align="center" color="white" width="0.5" height="0.2" side="double" wrap-count="8" baseline="center" position="0 0 0.11" scale="0.5 0.5 0.5"></a-text>
</a-box>

<a-text id="sistersHiTextLeft" value="You can trust us. Fight if you must." position="-2.688 0.941 1.25648" color="#fff" side="double" align="center" scale="0.15 0.15 0.15" visible="false" rotation="0 -22 0">
</a-text>
<a-text id="sistersHiTextShadowLeft" value="You can trust us. Fight if you must." position="-2.69203 0.941 1.25462" color="#000" side="double" align="center" scale="0.15 0.15 0.15" visible="false" rotation="0 -22 0">
</a-text>
<a-text id="sistersHiTextRight" value="Hi..." position="-2.42018 0.76278 1.39268" color="#fff" side="double" align="center" scale="0.2 0.2 0.2" visible="false" rotation="0 -22 0">
</a-text>
<a-text id="sistersHiTextShadowRight" value="Hi..." position="-2.42396 0.76335 1.39036" color="#000" side="double" align="center" scale="0.2 0.2 0.2" visible="false" rotation="0 -22 0">
</a-text>
<a-text id="sistersIgnoreText" value="Whatever..." position="-2.65302 0.94458 1.29681" color="#fff" side="double" align="center" scale="0.2 0.2 0.2" visible="false" rotation="0 -22 0">
</a-text>
<a-text id="sistersIgnoreTextShadow" value="Whatever..." position="-2.65535 0.94395 1.29506" color="#000" side="double" align="center" scale="0.2 0.2 0.2" visible="false" rotation="0 -22 0">
</a-text>

</a-scene>
    </div>
  <script>
      (function scatterTrees(){
  const trees=document.getElementById('trees');
  if(!trees) return;
  const treeTypes=['tree1','tree2','tree3','tree4']; // όλα τα δέντρα
  const branchTreeTypes=['tree1','tree2','tree3']; // Δέντρα μονοπατιών

function inPath(x, z) {
  // Κύριο μονοπάτι
  if (x > -1.2 && x < 1.2 && z > 10 && z < 30.5) return true;

 // Διασταύρωση κοντά στο fork
  if (x > -5.5 && x < 5.5 && z > 11 && z < 12.5) return true;

  // Διακλαδώσεις
if (x > -5 && x < -1 && z > -7 && z < 10) return true; // αριστερή
if (x > -1.2 && x < 1 && z > -7 && z < 10) return true; // μεσαία
if (x > 1.25 && x < 5 && z > -7 && z < 10) return true; // δεξιά

  // Άλλα μονοπάτια
  if (x > -4.5 && x < 4.5 && z > -8.5 && z < -7) return true;
  if (x > -1.3 && x < 1.3 && z > -16 && z < -7.25) return true;

  // Σπίτι
  if (x > -3.3 && x < 3.8 && z > 27.5 && z < 33.7) return true;
// Παλάτι
if (x > -8 && x < 7.5 && z > -30 && z < -12) return true;
  // Μάγισσα
  if (x > 1 && x < 4 && z > 3 && z < 6) return true;
  // Goblin 
  if (x > 2 && x < 4 && z > -6 && z < -2) return true;
  // Νεράιδες
  if (x > 2 && x < 5 && z > 6 && z < 8) return true;
  // Μανιτάρι
  if (x > 2 && x < 4 && z > -1 && z < 1) return true;
// Ghost + επιλογές
  if (x > -3.3 && x < -2.3 && z > -3.8 && z < -2.7) return true;
// Sisters + επιλογές + texts
if (x > -3.2 && x < -1.8 && z > 0.8 && z < 1.8) return true;  
if (x > -3.1 && x < -2.1 && z > 1.0 && z < 1.4) return true;  
if (x > -2.9 && x < -2.2 && z > 0.6 && z < 1.6) return true;   

// Μάγος + επιλογές + texts
if (x > -1.5 && x < 1.5 && z > -2.5 && z < -1.0) return true; 

  // Dwarf + text
  if (x > -0.5 && x < 0.5 && z > 4.1 && z < 5.2) return true; 
  if (x > -0.5 && x < 0.5 && z > 56 && z < 58) return true; 

  return false; // Αν δεν πέφτει σε μονοπάτι ή αποκλεισμένη περιοχή
}

// Scatter γενικών δέντρων
  for(let i=0;i<600;i++){
    let x=(Math.random()-0.5)*70, z=(Math.random()-0.5)*70;
    if(inPath(x,z)) continue;   // αγνοεί περιοχές μονοπατιών και NPCs
    const type=treeTypes[Math.floor(Math.random()*treeTypes.length)];
    if (type === 'tree4' && z > -7 && z < 9) continue;
    let scale=0.01+Math.random()*0.01;
    if(type==='tree4') scale*=35; if(type==='tree3') scale*=3.5;
    const rotY=Math.random()*360;
    let tree=document.createElement('a-entity');
    tree.setAttribute('gltf-model',`#${type}`);
    tree.setAttribute('position',`${x} 0 ${z}`);
    tree.setAttribute('scale',`${scale} ${scale} ${scale}`);
    tree.setAttribute('rotation',`0 ${rotY} 0`);
    trees.appendChild(tree);
  }
          
// Scatter δέντρων στις διακλαδώσεις
  for(let i=0;i<80;i++){
    const z=-6+Math.random()*14;
    let x = Math.random()<0.5 ? -2.0+(Math.random()*1.0) : 1.0+(Math.random()*1.0);
    const type=branchTreeTypes[Math.floor(Math.random()*branchTreeTypes.length)];
    let scale=0.01+Math.random()*0.01; if(type==='tree3') scale*=3.5;
    const rotY=Math.random()*360;
    let tree=document.createElement('a-entity');
    tree.setAttribute('gltf-model',`#${type}`);
    tree.setAttribute('position',`${x} 0 ${z}`);
    tree.setAttribute('scale',`${scale} ${scale} ${scale}`);
    tree.setAttribute('rotation',`0 ${rotY} 0`);
    trees.appendChild(tree);
  }
})();
  </script>

    <hr />
    <p><strong>Οδηγίες:<strong>
      Χρησιμοποίησε τα βελάκια του πληκτρολογίου για να κινηθείς στον χώρο, κράτα πατημένο το κουμπί του ποντικιού και μετακίνησέ το για να κοιτάξεις γύρω, και κάνε κλικ με τον δείκτη του ποντικιού για να επιλέξεις ενέργειες ή μονοπάτια.</p>
    <hr />
    <p><strong>Credits:</strong>
      "The Green Wizard Gnome N64 Style" - Drillimpact (https://sketchfab.com/3d-models/the-green-wizard-gnome-n64-style-7708c9dd60234693a6dcb326d66c627f),
      "Pixel Art/Voxel Art (Castle)" - Alex_F (https://sketchfab.com/3d-models/pixel-artvoxel-art-castle-850d3b288f6643b7a74190d54662553e),
      "Sequoia Redwood Tree Voxel" - WaxFreeOintment (https://sketchfab.com/3d-models/sequoia-redwood-tree-voxel-2757db6716b54d7a807caf5940428220),
      "Kapok Tree Voxel" - WaxFreeOintment (https://sketchfab.com/3d-models/kapok-tree-voxel-0a223ed8452b4c09853960386dccc6dd),
      "Giant Oak Tree Voxel" - WaxFreeOintment (https://sketchfab.com/3d-models/giant-oak-tree-voxel-d62cf4c17f3e447daaf31a0a57777268),
      "Voxel Models" - Na_ww_af59 (https://sketchfab.com/3d-models/voxel-models-09ccf7c8a02b400593c0a21443d731b5),
      "Mushroom Bup (Minecraft Mob)" - Bdog (https://sketchfab.com/3d-models/mushroom-bup-minecraft-mob-419123b9fc56403fb7f11c056515b64c),
      "Little Witch" - pedrodenovox (https://sketchfab.com/3d-models/little-witch-48b5f8143dd34ec1b39397765f182530),
      "Fairy gm villager3" - DaitekMC (https://sketchfab.com/3d-models/fairy-gm-villager3-db4d0ed4cef941b48045e7aa37356ee9),
      "Fairy gm villager4" - DaitekMC (https://sketchfab.com/3d-models/fairy-gm-villager4-348f1adaff1444818d5b77178b363b39),
      "Fairy gm villager6" - DaitekMC (https://sketchfab.com/3d-models/fairy-gm-villager6-ce4c1bc40b1c4b668639cd7805c87b07),
      "Fairy gm villager5" - DaitekMC (https://sketchfab.com/3d-models/fairy-gm-villager5-2bcb9730358f4f09abeded9217d17394),
      "Fairy gm villager1" - DaitekMC (https://sketchfab.com/3d-models/fairy-gm-villager1-807c48b871b8400f9196a39fc0de56d5),
      "Goblin Mob" - Alomare (https://sketchfab.com/3d-models/goblin-mob-e7aa6df01fef4f2d876190ddd0710802),
      "Big Medieval Town House #4" - Varles (https://sketchfab.com/3d-models/big-medieval-town-house-4-a4784f87a3274fa6bd8c4d0792eeb336),
      "Swaying Dwarf" - Ocfenton (https://sketchfab.com/3d-models/swaying-dwarf-1783db1377b8497582235ff7628d1e35),
      "Voxel Fox" - Spark Games (https://sketchfab.com/3d-models/voxel-fox-bb0178b180e840549bb034972949dd1e),
      "Sisters" - CutyPrincess (https://sketchfab.com/3d-models/sisters-50b70201b8b84b2891c197535b6b8c83),
      "Nightmare Creature 3#" - Idk (https://sketchfab.com/3d-models/nightmare-creature-3-62862bc678ca4a968bd34b141b31c7eb),
      "Creepy Girl" - mRiot (https://sketchfab.com/3d-models/creepy-girl-a53c3a6398a34a5186bce4803ee8eef0)
    </p>
        
    </body>

</html>
