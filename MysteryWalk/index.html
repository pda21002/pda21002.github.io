<html>
<head>
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
</head>
<body>
<a-scene cursor="rayOrigin: mouse" raycaster="objects: .fork-menu-button">

  <a-assets>
    <a-asset-item id="tree1" src="assets/giant_oak_tree_voxel.glb"></a-asset-item>
    <a-asset-item id="tree2" src="assets/kapok_tree_voxel.glb"></a-asset-item>
    <a-asset-item id="tree3" src="assets/sequoia_redwood_tree_voxel.glb"></a-asset-item>
    <a-asset-item id="tree4" src="assets/voxel_models.glb"></a-asset-item>
  </a-assets>

  <a-plane rotation="-90 0 0" width="50" height="50" material="color: green"></a-plane>

  <a-entity id="trees"></a-entity>

  <a-entity id="rig" player-movement>
    <a-camera position="0 0.5 16"></a-camera>
  </a-entity>

  <script>
    const trees = document.getElementById('trees');
    const treeTypes = ['tree1','tree2','tree3','tree4'];

    function inPath(x,z){
      const paths = [
        {x:[-0.75,0.75], z:[8.5,17]},
        {x:[-3, -2], z:[-10,8.75]},
        {x:[-0.75,0.75], z:[-10,8.75]},
        {x:[2,3], z:[-10,8.75]},
        {x:[-3.5,3.5], z:[-15,-10]}
      ];
      return paths.some(p => x>=p.x[0] && x<=p.x[1] && z>=p.z[0] && z<=p.z[1]);
    }

    for(let i=0;i<100;i++){
      let x=(Math.random()-0.5)*50;
      let z=(Math.random()-0.5)*50;
      if(inPath(x,z)) continue;

      const type = treeTypes[Math.floor(Math.random()*treeTypes.length)];
      let scale = 0.01 + Math.random()*0.02;
      let rotY = Math.random()*360;

      let tree = document.createElement('a-entity');
      tree.setAttribute('gltf-model', `#${type}`);
      tree.setAttribute('position', `${x} 0 ${z}`);
      tree.setAttribute('scale', `${scale} ${scale} ${scale}`);
      tree.setAttribute('rotation', `0 ${rotY} 0`);
      trees.appendChild(tree);
    }

    AFRAME.registerComponent('player-movement', {
      init: function() {
        this.keys = { w:false, a:false, s:false, d:false, ArrowUp:false, ArrowDown:false, ArrowLeft:false, ArrowRight:false };
        this.choiceMade = false;
        this.frozen = false;

        const rig = this.el;
        window.addEventListener('keydown', e => { if(this.keys[e.key]!==undefined) this.keys[e.key]=true; });
        window.addEventListener('keyup', e => { if(this.keys[e.key]!==undefined) this.keys[e.key]=false; });

        document.querySelectorAll('.fork-menu-button').forEach(btn => {
          btn.addEventListener('click', () => {
            this.choiceMade = true;
            this.frozen = false;
            document.getElementById('forkMenu').setAttribute('visible', false);
          });
        });
      },

      tick: function() {
        const rig = this.el;
        let pos = rig.getAttribute('position');
        const speed = 0.015;

        if(!this.choiceMade && pos.z <= 8.75){
          this.frozen = true;
          pos.z = 8.75;
          rig.setAttribute('position', pos);
          rig.setAttribute('rotation', '0 0 0');
          document.getElementById('forkMenu').setAttribute('visible', true);
          return;
        }

        if(!this.frozen){
          if(this.keys.w || this.keys.ArrowUp) pos.z -= speed;
          if(this.keys.s || this.keys.ArrowDown) pos.z += speed;
          if(this.keys.a || this.keys.ArrowLeft) pos.x -= speed;
          if(this.keys.d || this.keys.ArrowRight) pos.x += speed;
          rig.setAttribute('position', pos);
        }
      }
    });
  </script>
</a-scene>

</body>
</html>
