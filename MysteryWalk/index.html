<html>
  <head>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script>
AFRAME.registerComponent('player-movement', {
  init: function () {
    this.rig = document.getElementById('rig');

    // Initial bounds: start path
    this.currentBounds = { xMin: -0.75, xMax: 0.75, zMin: 8, zMax: 16 };
    this.choiceMade = false;

    this.keys = { w: false, a: false, s: false, d: false,
                  ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false };

    // Keyboard listeners
    window.addEventListener('keydown', e => { if(this.keys[e.key] !== undefined) this.keys[e.key] = true; });
    window.addEventListener('keyup', e => { if(this.keys[e.key] !== undefined) this.keys[e.key] = false; });

    // Fork menu clicks
    document.querySelectorAll('.fork-menu-button').forEach(btn => {
      btn.addEventListener('click', () => {
        const choice = btn.getAttribute('data-choice');
        if(choice === 'left') {
          this.currentBounds = { xMin: -3.25, xMax: -0.75, zMin: -6.5, zMax: 8 };
          document.querySelectorAll('.right-branch, .middle-branch').forEach(el => el.setAttribute('visible', false));
        } else if(choice === 'middle') {
          this.currentBounds = { xMin: -0.75, xMax: 0.75, zMin: -6.5, zMax: 8 };
          document.querySelectorAll('.left-branch, .right-branch').forEach(el => el.setAttribute('visible', false));
        } else if(choice === 'right') {
          this.currentBounds = { xMin: 0.75, xMax: 3.25, zMin: -6.5, zMax: 8 };
          document.querySelectorAll('.left-branch, .middle-branch').forEach(el => el.setAttribute('visible', false));
        }
        this.choiceMade = true;
        document.getElementById('forkMenu').setAttribute('visible', false);
      });
    });
  },

  tick: function () {
    let pos = this.rig.getAttribute('position');
    const speed = 0.02; // slower movement

    // Force stop at fork
    if(!this.choiceMade && pos.z <= 8) {
      pos.z = 8;
      this.rig.setAttribute('position', pos);
      document.getElementById('forkMenu').setAttribute('visible', true);
      return;
    }

    // Movement (absolute world directions)
    if(this.keys.w || this.keys.ArrowUp) pos.z -= speed;
    if(this.keys.s || this.keys.ArrowDown) pos.z += speed;
    if(this.keys.a || this.keys.ArrowLeft) pos.x -= speed;
    if(this.keys.d || this.keys.ArrowRight) pos.x += speed;

    // Clamp to current bounds
    pos.x = Math.max(this.currentBounds.xMin, Math.min(this.currentBounds.xMax, pos.x));
    pos.z = Math.max(this.currentBounds.zMin, Math.min(this.currentBounds.zMax, pos.z));

    this.rig.setAttribute('position', pos);
  }
});
    </script>
  </head>

  <body>
    <a-scene>
      <!-- Assets -->
      <a-assets>
        <img id="groundTexture" src="assets/grass.jpg">
        <img id="pathTexture" src="assets/stone.png">
      </a-assets>

      <!-- Ground -->
      <a-plane rotation="-90 0 0" width="50" height="50" material="repeat: 20 20; shader: flat; src: #groundTexture" position="0 0 0" scale="1.5 1.5 1.5"></a-plane>

      <!-- Paths -->
      <!-- Intro straight -->
      <a-box width="1.5" height="0.05" depth="8" position="0 0 20.72463"
             material="src: #pathTexture; repeat: 1 4; shader: flat;"></a-box>

      <!-- Fork horizontal -->
      <a-box width="7" height="0.05" depth="1.5" position="0 0.03 8"
             material="src: #pathTexture; repeat: 7 1; shader: flat;"></a-box>

      <!-- Branches -->
      <!-- LEFT branch (all segments assigned correctly) -->
      <a-box class="left-branch" width="1.5" height="0.05" depth="14" position="-4.96322 0.025 4.77748"
             material="src: #pathTexture; repeat: 1 7; shader: flat;"></a-box>
      <a-box class="left-branch" width="1.5" height="0.05" depth="14" position="-4.98658 0.025 -9.9741"
             material="src: #pathTexture; repeat: 1 7; shader: flat;"></a-box>

      <!-- MIDDLE branch -->
      <a-box class="middle-branch" width="1.5" height="0.05" depth="14" position="0 0.025 0"
             material="src: #pathTexture; repeat: 1 7; shader: flat;"></a-box>

      <!-- RIGHT branch (all segments assigned correctly) -->
      <a-box class="right-branch" width="1.5" height="0.05" depth="14" position="4.90985 0.025 4.80607"
             material="src: #pathTexture; repeat: 1 7; shader: flat;"></a-box>
      <a-box class="right-branch" width="1.5" height="0.05" depth="14" position="4.99697 0.025 -9.9741"
             material="src: #pathTexture; repeat: 1 7; shader: flat;"></a-box>

      <!-- Ending straight -->
      <a-box width="7" height="0.05" depth="1.5" position="0 0.01938 -13.259"
             material="src: #pathTexture; repeat: 7 1; shader: flat;"></a-box>
      <a-box width="1.5" height="0.05" depth="8" position="0 0.025 -20.03125"
             material="src: #pathTexture; repeat: 1 4; shader: flat;"></a-box>

      <!-- Fork menu -->
      <a-entity id="forkMenu" visible="false" position="0 1.5 6">
        <a-box class="fork-menu-button" data-choice="left" position="-2 0 0" width="1" height="0.5" depth="0.2" color="blue"></a-box>
        <a-box class="fork-menu-button" data-choice="middle" position="0 0 0" width="1" height="0.5" depth="0.2" color="yellow"></a-box>
        <a-box class="fork-menu-button" data-choice="right" position="2 0 0" width="1" height="0.5" depth="0.2" color="red"></a-box>
      </a-entity>

      <!-- Castle -->
      <a-box id="castle" position="0 0.5 -27.07426" width="2" height="2" depth="2" color="gold"></a-box>

      <!-- Player -->
      <a-entity id="rig" position="0 0.5 31.55928" player-movement>
        <a-entity camera look-controls="pointerLockEnabled: true"></a-entity>
      </a-entity>
    </a-scene>
  </body>
</html>
